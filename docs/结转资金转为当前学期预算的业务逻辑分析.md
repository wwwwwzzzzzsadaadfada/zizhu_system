# 结转资金转为当前学期预算的业务逻辑分析

## 一、结转流程

### 1. carryOverToBudget 方法（直接结转到预算）

**流程**：
1. 选择历史学期的指标（`sourceQuota`）
2. 验证：`sourceQuota.getYearSemesterId() < currentSemester.getId()`（只能结转历史学期）
3. 计算可结转金额
4. **创建预算**：
   ```java
   budget.setYearSemesterId(request.getYearSemesterId()); // 当前学期ID
   budget.setQuotaId(sourceQuota.getId());                // 历史学期指标的ID
   budget.setQuotaDetailId(detail.getId());               // 历史学期指标明细的ID
   ```

**关键点**：
- 预算的 `yearSemesterId` = **当前学期ID**
- 预算的 `quotaId` = **历史学期指标的ID**
- 查询预算时，通过 `left join st_subsidy_quota q on b.quota_id = q.id` 获取指标的 `quota_source_type` 和 `year_semester_id`

### 2. carryOverToTargetQuota 方法（结转到目标指标，然后再分配预算）

**流程**：
1. 选择历史学期的指标（`sourceQuota`）
2. 创建新的指标（`targetQuota`），设置：
   ```java
   newQuota.setYearSemesterId(request.getYearSemesterId()); // 当前学期ID
   newQuota.setQuotaSourceType(2);                          // 上学期结转
   newQuota.setSourceQuotaId(sourceQuota.getId());          // 记录来源指标ID
   ```
3. 然后通过其他流程将目标指标分配到预算

**关键点**：
- 新指标的 `yearSemesterId` = **当前学期ID**
- 新指标的 `quotaSourceType` = **2（上学期结转）**
- 如果从这种指标创建预算，预算的 `quotaSourceType` = 2

## 二、数据结构关系

### 预算查询时的关联

```sql
select 
    b.id, b.year_semester_id,           -- 预算的学期ID（当前学期ID）
    q.quota_source_type,                 -- 指标的来源类型（关联查询）
    q.year_semester_id as quota_year_semester_id  -- 指标的学年学期ID（关联查询）
from st_semester_budget b
left join st_subsidy_quota q on b.quota_id = q.id
```

**重要**：
- `b.year_semester_id`：预算的学期ID（结转后 = 当前学期ID）
- `q.year_semester_id`：指标的学年学期ID（如果是历史学期指标，< 当前学期ID）
- `q.quota_source_type`：指标的来源类型

## 三、判断结余资金的正确方式

### 当前代码的问题

当前代码判断是否为结余资金，主要通过 `quotaSourceType`：
- 如果 `quotaSourceType = 2 或 3`，判断为结余资金

**但这不准确**，因为：
1. 如果历史学期指标本身的 `quotaSourceType = 1`（原本就是新下达的指标）
2. 通过 `carryOverToBudget` 直接结转到预算
3. 那么预算关联的指标的 `quotaSourceType` 仍然是 1
4. 但实际是结余资金（因为指标的 `yearSemesterId` < 当前学期ID）

### 正确的判断方式

**判断是否为结余资金，应该看**：
1. 预算的 `yearSemesterId` = 当前学期ID（预算在当前学期可用）
2. **且** 指标的 `yearSemesterId`（`quotaYearSemesterId`）< 当前学期ID（指标来自历史学期）

**或者**：
- 指标的 `quotaSourceType = 2 或 3`（明确标识为结转指标）

### 综合判断逻辑

```
if (预算的yearSemesterId == 当前学期ID) {
    if (指标的quotaSourceType == 2 或 3) {
        // 结余资金（明确标识为结转）
        return true;
    } else if (指标的yearSemesterId < 当前学期ID) {
        // 结余资金（指标来自历史学期）
        return true;
    } else {
        // 本学期下达的预算
        return false;
    }
} else {
    // 历史预算（预算的学期ID < 当前学期ID，不可用）
    return false;
}
```

## 四、解决方案

### 修改 toVO 方法

在 `toVO` 方法中，判断是否为结余资金：

```java
private BudgetVO toVO(@NonNull StSemesterBudget budget, boolean isHistorical) {
    BudgetVO vo = new BudgetVO();
    BeanUtils.copyProperties(budget, vo);
    
    // 判断是否为结余资金
    // 方式1：指标的quotaSourceType = 2 或 3（明确标识为结转）
    boolean isCarryOverByType = QuotaSourceUtils.isCarryOver(budget.getQuotaSourceType());
    
    // 方式2：指标的yearSemesterId < 当前学期ID（指标来自历史学期）
    // 注意：这里需要当前学期ID，但toVO方法中没有，需要从外部传入或者从budget对象获取
    // 由于预算的yearSemesterId已经等于当前学期ID（在getAvailableBudgets中查询的），
    // 所以如果quotaYearSemesterId存在且 < budget.getYearSemesterId()，就是结余资金
    
    // 综合判断
    boolean isSurplus = isCarryOverByType 
        || (budget.getQuotaYearSemesterId() != null 
            && budget.getYearSemesterId() != null
            && budget.getQuotaYearSemesterId() < budget.getYearSemesterId());
    
    vo.setIsHistorical(isSurplus);
    
    // 如果是结余资金，在预算项目名称后面加上（结余）标识
    if (isSurplus && budget.getBudgetProjectName() != null && !budget.getBudgetProjectName().trim().isEmpty()) {
        String budgetProjectName = budget.getBudgetProjectName();
        if (!budgetProjectName.endsWith("（结余）") && !budgetProjectName.endsWith("(结余)")) {
            vo.setBudgetProjectName(budgetProjectName + "（结余）");
        }
    }
    
    return vo;
}
```

### 修改 getAvailableBudgets 方法

**当前代码**：
```java
List<StSemesterBudget> currentSemesterBudgets = HistoricalSurplusUtils.filterCurrentSemesterBudgets(
    allBudgets, currentSchoolYear, currentSemesterValue);
return toVOList(currentSemesterBudgets, false);
```

**问题**：
- `filterCurrentSemesterBudgets` 会过滤掉 `quotaSourceType = 2 或 3` 的预算
- 导致结余资金无法显示

**应该改为**：
```java
// 不过滤，所有在当前学期的预算都应该返回
// 在toVO中根据quotaSourceType和quotaYearSemesterId判断是否为结余资金
return toVOList(allBudgets, false);
```

## 五、总结

### 关键理解

1. **结转后的预算**：
   - 预算的 `yearSemesterId` = 当前学期ID（在当前学期可用）
   - 预算的 `quotaId` = 历史学期指标的ID
   - 通过关联查询，可以获取指标的 `quotaSourceType` 和 `yearSemesterId`

2. **判断结余资金的两种方式**：
   - **方式1**：指标的 `quotaSourceType = 2 或 3`（明确标识为结转）
   - **方式2**：指标的 `yearSemesterId`（`quotaYearSemesterId`）< 当前学期ID（指标来自历史学期）

3. **getAvailableBudgets应该返回**：
   - 所有 `yearSemesterId = 当前学期ID` 的预算（包括结余资金）
   - 不需要过滤 `quotaSourceType`
   - 在 `toVO` 中区分显示即可


