# 指标表结构（修改后）

## 一、指标主表 (st_subsidy_quota)

### 1.1 表结构

```sql
CREATE TABLE st_subsidy_quota (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '主键ID',
    year_semester_id BIGINT NOT NULL COMMENT '学年学期ID',
    issue_date DATE COMMENT '发文时间',
    quota_doc_no VARCHAR(100) COMMENT '指标文号',
    budget_project_name VARCHAR(200) COMMENT '预算项目名称',
    total_quota DECIMAL(18,2) DEFAULT 0 COMMENT '总指标金额',
    function_category VARCHAR(20) COMMENT '功能分类（1=小学,2=初中,3=高中）',
    economy_category VARCHAR(20) COMMENT '经济分类（1=助学金,2=免学杂费,3=免学费,4=营养改善计划）',
    budget_level VARCHAR(20) COMMENT '预算级次',
    allocated_amount DECIMAL(18,2) DEFAULT 0 COMMENT '已分配金额',
    status INT DEFAULT 1 COMMENT '状态（1=启用,2=部分分配,3=已分配,4=锁定）',
    quota_source_type INT DEFAULT 1 COMMENT '指标来源类型（1=本学期新下达,2=上学期结转,3=历史学期结转）',
    source_quota_id BIGINT COMMENT '来源指标ID（结转时记录原指标ID）',
    memo TEXT COMMENT '备注',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    INDEX idx_year_semester_id (year_semester_id),
    INDEX idx_quota_doc_no (quota_doc_no),
    INDEX idx_function_category (function_category),
    INDEX idx_economy_category (economy_category),
    INDEX idx_source_quota_id (source_quota_id),
    INDEX idx_status (status),
    INDEX idx_quota_source_type (quota_source_type)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='资助指标下达表';
```

### 1.2 字段说明

| 字段名 | 类型 | 必填 | 说明 | 备注 |
|--------|------|------|------|------|
| `id` | BIGINT | 是 | 主键ID | 自增 |
| `year_semester_id` | BIGINT | 是 | 学年学期ID | 关联 `st_school_year_semester.id` |
| `issue_date` | DATE | 否 | 发文时间 | 指标文件发布日期 |
| `quota_doc_no` | VARCHAR(100) | 否 | 指标文号 | 指标文件的文号 |
| `budget_project_name` | VARCHAR(200) | 否 | 预算项目名称 | 预算项目名称 |
| `total_quota` | DECIMAL(18,2) | 是 | 总指标金额 | 从明细表汇总，默认0 |
| `function_category` | VARCHAR(20) | 否 | 功能分类 | 字典：sys_function_category |
| `economy_category` | VARCHAR(20) | 否 | 经济分类 | 字典：sys_economy_category（主分类） |
| `budget_level` | VARCHAR(20) | 否 | 预算级次 | 字典：sys_budget_level |
| `allocated_amount` | DECIMAL(18,2) | 是 | 已分配金额 | 从预算表汇总，默认0 |
| `status` | INT | 是 | 状态 | 1=启用,2=部分分配,3=已分配,4=锁定 |
| `quota_source_type` | INT | 是 | 指标来源类型 | 1=本学期新下达,2=上学期结转,3=历史学期结转 |
| `source_quota_id` | BIGINT | 否 | 来源指标ID | 结转时记录原指标ID |
| `memo` | TEXT | 否 | 备注 | 备注信息 |
| `created_at` | DATETIME | 是 | 创建时间 | 自动设置 |
| `updated_at` | DATETIME | 是 | 更新时间 | 自动更新 |

### 1.3 已移除的字段

以下字段已在本次简化中移除：

- ❌ `superior_doc_no` - 上级文号
- ❌ `quota_doc_title` - 指标文标题
- ❌ `budget_project_code` - 预算项目编码
- ❌ `quota_summary` - 指标摘要
- ❌ `budget_source` - 预算来源

### 1.4 索引说明

- `idx_year_semester_id` - 学年学期查询优化
- `idx_quota_doc_no` - 指标文号查询优化
- `idx_function_category` - 功能分类过滤
- `idx_economy_category` - 经济分类过滤
- `idx_source_quota_id` - 结转查询优化
- `idx_status` - 状态过滤
- `idx_quota_source_type` - 指标来源类型过滤

---

## 二、指标明细表 (st_subsidy_quota_detail)

### 2.1 表结构

```sql
CREATE TABLE st_subsidy_quota_detail (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '主键ID',
    quota_id BIGINT NOT NULL COMMENT '关联指标主表ID',
    economy_category VARCHAR(20) NOT NULL COMMENT '经济分类（1=助学金,2=免学杂费,3=免学费,4=营养改善计划）',
    total_amount DECIMAL(18,2) DEFAULT 0 COMMENT '该分类下的总金额',
    allocated_amount DECIMAL(18,2) DEFAULT 0 COMMENT '已分配金额',
    status INT DEFAULT 1 COMMENT '状态（1=启用,0=停用）',
    memo TEXT COMMENT '备注',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    INDEX idx_quota_id (quota_id),
    INDEX idx_economy_category (economy_category),
    INDEX idx_status (status),
    FOREIGN KEY (quota_id) REFERENCES st_subsidy_quota(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='资助指标经济分类明细表';
```

### 2.2 字段说明

| 字段名 | 类型 | 必填 | 说明 | 备注 |
|--------|------|------|------|------|
| `id` | BIGINT | 是 | 主键ID | 自增 |
| `quota_id` | BIGINT | 是 | 关联指标主表ID | 外键关联 `st_subsidy_quota.id` |
| `economy_category` | VARCHAR(20) | 是 | 经济分类 | 字典：sys_economy_category |
| `total_amount` | DECIMAL(18,2) | 是 | 该分类下的总金额 | 默认0 |
| `allocated_amount` | DECIMAL(18,2) | 是 | 已分配金额 | 从预算表汇总，默认0 |
| `status` | INT | 是 | 状态 | 1=启用,0=停用 |
| `memo` | TEXT | 否 | 备注 | 备注信息 |
| `created_at` | DATETIME | 是 | 创建时间 | 自动设置 |
| `updated_at` | DATETIME | 是 | 更新时间 | 自动更新 |

### 2.3 业务说明

- 一个指标可以有多个明细（一个明细对应一个经济分类）
- 根据业务需求，一个指标通常只有一个明细（助学金或免学杂费）
- `total_amount` 的总和应该等于主表的 `total_quota`
- `allocated_amount` 从 `st_semester_budget` 表汇总

---

## 三、学期预算表 (st_semester_budget)

### 3.1 表结构

```sql
CREATE TABLE st_semester_budget (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '主键ID',
    year_semester_id BIGINT NOT NULL COMMENT '学年学期ID',
    quota_id BIGINT NOT NULL COMMENT '关联指标ID',
    quota_detail_id BIGINT NOT NULL COMMENT '关联指标明细ID',
    budget_type VARCHAR(50) COMMENT '预算类型',
    budget_amount DECIMAL(18,2) DEFAULT 0 COMMENT '预算总额',
    used_amount DECIMAL(18,2) DEFAULT 0 COMMENT '已使用金额',
    locked_amount DECIMAL(18,2) DEFAULT 0 COMMENT '锁定金额（审批中）',
    status INT DEFAULT 1 COMMENT '预算状态（1=启用,2=冻结,3=已用完,4=作废）',
    memo TEXT COMMENT '备注',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    INDEX idx_year_semester_id (year_semester_id),
    INDEX idx_quota_id (quota_id),
    INDEX idx_quota_detail_id (quota_detail_id),
    INDEX idx_status (status),
    FOREIGN KEY (quota_id) REFERENCES st_subsidy_quota(id) ON DELETE RESTRICT,
    FOREIGN KEY (quota_detail_id) REFERENCES st_subsidy_quota_detail(id) ON DELETE RESTRICT
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='学期预算支出表';
```

### 3.2 字段说明

| 字段名 | 类型 | 必填 | 说明 | 备注 |
|--------|------|------|------|------|
| `id` | BIGINT | 是 | 主键ID | 自增 |
| `year_semester_id` | BIGINT | 是 | 学年学期ID | 关联 `st_school_year_semester.id` |
| `quota_id` | BIGINT | 是 | 关联指标ID | 外键关联 `st_subsidy_quota.id` |
| `quota_detail_id` | BIGINT | 是 | 关联指标明细ID | 外键关联 `st_subsidy_quota_detail.id` |
| `budget_type` | VARCHAR(50) | 否 | 预算类型 | 预算类型标识 |
| `budget_amount` | DECIMAL(18,2) | 是 | 预算总额 | 默认0 |
| `used_amount` | DECIMAL(18,2) | 是 | 已使用金额 | 已审批通过的金额，默认0 |
| `locked_amount` | DECIMAL(18,2) | 是 | 锁定金额 | 审批中的金额，默认0 |
| `status` | INT | 是 | 预算状态 | 1=启用,2=冻结,3=已用完,4=作废 |
| `memo` | TEXT | 否 | 备注 | 备注信息 |
| `created_at` | DATETIME | 是 | 创建时间 | 自动设置 |
| `updated_at` | DATETIME | 是 | 更新时间 | 自动更新 |

### 3.3 关联查询字段（不存数据库）

以下字段通过关联查询获取，不存储在 `st_semester_budget` 表中：

- `quota_doc_no` - 指标文号（从 `st_subsidy_quota` 查询）
- `budget_project_name` - 预算项目名称（从 `st_subsidy_quota` 查询）
- `economy_category` - 经济分类（从 `st_subsidy_quota_detail` 查询）
- `function_category` - 功能分类（从 `st_subsidy_quota` 查询）
- `quota_source_type` - 指标来源类型（从 `st_subsidy_quota` 查询）

**注意**：已移除 `quota_doc_title` 字段的关联查询。

---

## 四、表关系图

```
st_subsidy_quota (指标主表)
    ├── id (PK)
    ├── year_semester_id (FK -> st_school_year_semester.id)
    ├── quota_doc_no
    ├── total_quota
    ├── allocated_amount
    └── ...
    │
    ├── 1:N ──→ st_subsidy_quota_detail (指标明细表)
    │              ├── id (PK)
    │              ├── quota_id (FK -> st_subsidy_quota.id)
    │              ├── economy_category
    │              ├── total_amount
    │              └── allocated_amount
    │
    └── 1:N ──→ st_semester_budget (学期预算表)
                   ├── id (PK)
                   ├── quota_id (FK -> st_subsidy_quota.id)
                   ├── quota_detail_id (FK -> st_subsidy_quota_detail.id)
                   ├── budget_amount
                   ├── used_amount
                   └── locked_amount
```

---

## 五、数据字典

### 5.1 功能分类 (sys_function_category)

| 值 | 标签 | 说明 |
|----|------|------|
| 1 | 小学 | 小学阶段 |
| 2 | 初中 | 初中阶段 |
| 3 | 高中 | 高中阶段 |

### 5.2 经济分类 (sys_economy_category)

| 值 | 标签 | 说明 |
|----|------|------|
| 1 | 助学金 | 助学金类型 |
| 2 | 免学杂费 | 免学杂费类型 |
| 3 | 免学费 | 免学费类型 |
| 4 | 营养改善计划 | 营养改善计划 |

### 5.3 预算级次 (sys_budget_level)

| 值 | 标签 | 说明 |
|----|------|------|
| ... | ... | 根据实际业务定义 |

### 5.4 指标状态 (sys_quota_status)

| 值 | 标签 | 说明 |
|----|------|------|
| 1 | 启用 | 指标已启用 |
| 2 | 部分分配 | 指标已部分分配 |
| 3 | 已分配 | 指标已全部分配 |
| 4 | 锁定 | 指标已锁定 |

### 5.5 指标来源类型 (sys_quota_source_type)

| 值 | 标签 | 说明 |
|----|------|------|
| 1 | 本学期新下达 | 本学期新下达的指标 |
| 2 | 上学期结转 | 从上学期结转的指标 |
| 3 | 历史学期结转 | 从历史学期结转的指标 |

### 5.6 预算状态 (sys_budget_status)

| 值 | 标签 | 说明 |
|----|------|------|
| 1 | 启用 | 预算已启用 |
| 2 | 冻结 | 预算已冻结 |
| 3 | 已用完 | 预算已用完 |
| 4 | 作废 | 预算已作废 |

---

## 六、修改说明

### 6.1 本次修改内容

1. **指标主表简化**：
   - 移除了 5 个字段：`superior_doc_no`、`quota_doc_title`、`budget_project_code`、`quota_summary`、`budget_source`
   - 保留了核心业务字段和必要的关联字段

2. **明细表保持不变**：
   - `st_subsidy_quota_detail` 表结构未修改
   - 继续支持一个指标多个明细的设计

3. **学期预算表关联查询更新**：
   - 移除了对 `quota_doc_title` 的关联查询
   - 保留了其他必要的关联查询字段

### 6.2 影响范围

- ✅ 后端实体类已更新
- ✅ Mapper XML 已更新
- ✅ 前端页面已更新
- ✅ 关联查询已更新

### 6.3 数据库迁移建议

如果数据库中已存在这些字段，建议执行以下 SQL 进行清理：

```sql
-- 注意：执行前请备份数据！

-- 移除指标主表的已删除字段
ALTER TABLE st_subsidy_quota 
    DROP COLUMN IF EXISTS superior_doc_no,
    DROP COLUMN IF EXISTS quota_doc_title,
    DROP COLUMN IF EXISTS budget_project_code,
    DROP COLUMN IF EXISTS quota_summary,
    DROP COLUMN IF EXISTS budget_source;
```

---

## 七、总结

修改后的表结构更加简洁，移除了冗余字段，保留了核心业务功能。明细表结构保持不变，继续支持灵活的经济分类管理。




