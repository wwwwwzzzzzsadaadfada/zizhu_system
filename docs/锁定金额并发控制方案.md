# é”å®šé‡‘é¢å¹¶å‘æ§åˆ¶æ–¹æ¡ˆ

## ä¸€ã€å½“å‰å®ç°çš„å¹¶å‘é—®é¢˜åˆ†æ

### 1. **å­˜åœ¨çš„å¹¶å‘é£é™©**

#### åœºæ™¯1ï¼šå¤šç”¨æˆ·åŒæ—¶åˆ›å»ºè¡¥åŠ©è®°å½•ï¼ˆè¶…æ”¯é£é™©ï¼‰âš ï¸
```
æ—¶é—´çº¿ï¼š
T1: ç”¨æˆ·AæŸ¥è¯¢é¢„ç®—ï¼Œå¯ç”¨é‡‘é¢=10000ï¼Œéœ€è¦5000 âœ…
T2: ç”¨æˆ·BæŸ¥è¯¢é¢„ç®—ï¼Œå¯ç”¨é‡‘é¢=10000ï¼Œéœ€è¦6000 âœ…
T3: ç”¨æˆ·Aæ‰§è¡ŒUPDATEï¼Œé”å®š5000ï¼Œå‰©ä½™5000
T4: ç”¨æˆ·Bæ‰§è¡ŒUPDATEï¼Œé”å®š6000ï¼Œä½†å®é™…åªæœ‰5000å¯ç”¨ âŒ è¶…æ”¯ï¼
```

#### åœºæ™¯2ï¼šæŸ¥è¯¢å’Œæ›´æ–°ä¹‹é—´çš„ç«æ€æ¡ä»¶
```java
// å½“å‰ä»£ç æµç¨‹
1. æŸ¥è¯¢é¢„ç®—å¯ç”¨é‡‘é¢ï¼ˆSELECTï¼‰
2. éªŒè¯å¯ç”¨é‡‘é¢æ˜¯å¦è¶³å¤Ÿï¼ˆä¸šåŠ¡é€»è¾‘ï¼‰
3. æ›´æ–°é”å®šé‡‘é¢ï¼ˆUPDATEï¼‰
```
**é—®é¢˜**ï¼šæ­¥éª¤1å’Œ3ä¹‹é—´ï¼Œå…¶ä»–çº¿ç¨‹å¯èƒ½å·²ç»ä¿®æ”¹äº†æ•°æ®

#### åœºæ™¯3ï¼šå®¡æ‰¹æ—¶çš„å¹¶å‘é—®é¢˜
```java
// å®¡æ‰¹é€šè¿‡æ—¶
1. æŸ¥è¯¢é¢„ç®—é”å®šé‡‘é¢
2. å‡å°‘é”å®šé‡‘é¢
3. å¢åŠ å·²ä½¿ç”¨é‡‘é¢
```
**é—®é¢˜**ï¼šå¦‚æœåŒæ—¶å®¡æ‰¹å¤šæ¡è®°å½•ï¼Œå¯èƒ½å¯¼è‡´æ•°æ®ä¸ä¸€è‡´

---

## äºŒã€å½“å‰å®ç°çš„ä¿æŠ¤æœºåˆ¶

### 1. **æ•°æ®åº“äº‹åŠ¡ï¼ˆ@Transactionalï¼‰**
```java
@Transactional
public int insertStStudentSubsidyRecord(...) {
    // é”å®šé¢„ç®—é‡‘é¢
    int locked = stSemesterBudgetMapper.lockBudgetAmount(...);
    // æ’å…¥è¡¥åŠ©è®°å½•
    return stStudentSubsidyRecordMapper.insertStStudentSubsidyRecord(...);
}
```

**ä½œç”¨**ï¼š
- âœ… ä¿è¯åŸå­æ€§ï¼ˆè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å›æ»šï¼‰
- âœ… ä¿è¯éš”ç¦»æ€§ï¼ˆä¸åŒäº‹åŠ¡ä¹‹é—´éš”ç¦»ï¼‰

**ä¸è¶³**ï¼š
- âŒ ä¸èƒ½é˜²æ­¢å¹¶å‘æ›´æ–°å¯¼è‡´çš„è¶…æ”¯é—®é¢˜
- âŒ WHEREæ¡ä»¶æ£€æŸ¥åœ¨UPDATEæ—¶æ‰§è¡Œï¼Œä½†æŸ¥è¯¢å’Œæ›´æ–°ä¹‹é—´ä»æœ‰æ—¶é—´çª—å£

### 2. **SQL WHEREæ¡ä»¶æ£€æŸ¥ï¼ˆéƒ¨åˆ†ä¿æŠ¤ï¼‰**
```sql
UPDATE st_semester_budget
SET locked_amount = COALESCE(locked_amount, 0) + #{amount}
WHERE id = #{budgetId}
AND (budget_amount - COALESCE(used_amount, 0) - COALESCE(locked_amount, 0)) >= #{amount}
```

**ä½œç”¨**ï¼š
- âœ… åœ¨UPDATEæ—¶å†æ¬¡æ£€æŸ¥å¯ç”¨é‡‘é¢
- âœ… å¦‚æœå¯ç”¨é‡‘é¢ä¸è¶³ï¼ŒUPDATEå½±å“è¡Œæ•°ä¸º0

**ä¸è¶³**ï¼š
- âš ï¸ åªèƒ½é˜²æ­¢æ˜æ˜¾çš„è¶…æ”¯ï¼Œä½†ä»æœ‰ç«æ€æ¡ä»¶
- âš ï¸ ä¸¤ä¸ªå¹¶å‘è¯·æ±‚å¯èƒ½éƒ½é€šè¿‡WHEREæ£€æŸ¥ï¼Œä½†å®é™…åªæœ‰ä¸€ä»½ä½™é¢

---

## ä¸‰ã€éœ€è¦çš„é”æœºåˆ¶

### æ–¹æ¡ˆ1ï¼šæ•°æ®åº“æ‚²è§‚é”ï¼ˆSELECT FOR UPDATEï¼‰â­æ¨è

#### å®ç°æ–¹å¼
```java
// åœ¨Mapperä¸­æ·»åŠ 
@Select("SELECT * FROM st_semester_budget WHERE id = #{id} FOR UPDATE")
StSemesterBudget selectStSemesterBudgetByIdForUpdate(Long id);

// åœ¨Serviceä¸­ä½¿ç”¨
@Transactional
public int insertStStudentSubsidyRecord(...) {
    // 1. ä½¿ç”¨æ‚²è§‚é”æŸ¥è¯¢é¢„ç®—
    StSemesterBudget budget = stSemesterBudgetMapper.selectStSemesterBudgetByIdForUpdate(
        stStudentSubsidyRecord.getBudgetId()
    );
    
    // 2. éªŒè¯å¯ç”¨é‡‘é¢
    BigDecimal available = budget.getBudgetAmount()
        .subtract(budget.getUsedAmount() != null ? budget.getUsedAmount() : BigDecimal.ZERO)
        .subtract(budget.getLockedAmount() != null ? budget.getLockedAmount() : BigDecimal.ZERO);
    
    if (available.compareTo(stStudentSubsidyRecord.getSubsidyAmount()) < 0) {
        throw new ServiceException("é¢„ç®—ä½™é¢ä¸è¶³");
    }
    
    // 3. æ›´æ–°é”å®šé‡‘é¢ï¼ˆæ­¤æ—¶å…¶ä»–äº‹åŠ¡è¢«é˜»å¡ï¼‰
    int locked = stSemesterBudgetMapper.lockBudgetAmount(...);
    
    // 4. æ’å…¥è¡¥åŠ©è®°å½•
    return stStudentSubsidyRecordMapper.insertStStudentSubsidyRecord(...);
}
```

**ä¼˜ç‚¹**ï¼š
- âœ… å®Œå…¨é˜²æ­¢å¹¶å‘é—®é¢˜
- âœ… å®ç°ç®€å•ï¼Œæ•°æ®åº“å±‚é¢ä¿è¯
- âœ… é€‚åˆé«˜å¹¶å‘åœºæ™¯

**ç¼ºç‚¹**ï¼š
- âš ï¸ ä¼šé˜»å¡å…¶ä»–äº‹åŠ¡ï¼Œå¯èƒ½å½±å“æ€§èƒ½
- âš ï¸ éœ€è¦åˆç†çš„äº‹åŠ¡éš”ç¦»çº§åˆ«

**é€‚ç”¨åœºæ™¯**ï¼š**æ¨èç”¨äºé¢„ç®—é”å®šé‡‘é¢åœºæ™¯**

---

### æ–¹æ¡ˆ2ï¼šä¹è§‚é”ï¼ˆVersionå­—æ®µï¼‰â­æ¨èï¼ˆè¯»å¤šå†™å°‘ï¼‰

#### å®ç°æ–¹å¼
```java
// 1. åœ¨é¢„ç®—è¡¨æ·»åŠ versionå­—æ®µ
ALTER TABLE st_semester_budget ADD COLUMN version INT DEFAULT 0;

// 2. åœ¨å®ä½“ç±»æ·»åŠ versionå­—æ®µ
public class StSemesterBudget {
    private Integer version;
    // ...
}

// 3. åœ¨Mapperä¸­ä½¿ç”¨ç‰ˆæœ¬å·
<update id="lockBudgetAmountWithVersion">
    UPDATE st_semester_budget
    SET locked_amount = COALESCE(locked_amount, 0) + #{param2},
        version = version + 1,
        updated_at = NOW()
    WHERE id = #{param1}
    AND version = #{param3}  -- ç‰ˆæœ¬å·å¿…é¡»åŒ¹é…
    AND (budget_amount - COALESCE(used_amount, 0) - COALESCE(locked_amount, 0)) >= #{param2}
</update>

// 4. åœ¨Serviceä¸­ä½¿ç”¨
@Transactional
public int insertStStudentSubsidyRecord(...) {
    // 1. æŸ¥è¯¢é¢„ç®—ï¼ˆå¸¦ç‰ˆæœ¬å·ï¼‰
    StSemesterBudget budget = stSemesterBudgetMapper.selectStSemesterBudgetById(...);
    Integer currentVersion = budget.getVersion();
    
    // 2. éªŒè¯å¯ç”¨é‡‘é¢
    BigDecimal available = ...;
    if (available.compareTo(amount) < 0) {
        throw new ServiceException("é¢„ç®—ä½™é¢ä¸è¶³");
    }
    
    // 3. æ›´æ–°ï¼ˆå¸¦ç‰ˆæœ¬å·æ£€æŸ¥ï¼‰
    int locked = stSemesterBudgetMapper.lockBudgetAmountWithVersion(
        budgetId, amount, currentVersion
    );
    
    if (locked == 0) {
        // ç‰ˆæœ¬å·ä¸åŒ¹é…æˆ–ä½™é¢ä¸è¶³ï¼Œé‡è¯•æˆ–æŠ›å¼‚å¸¸
        throw new ServiceException("é¢„ç®—å·²è¢«å…¶ä»–æ“ä½œä¿®æ”¹ï¼Œè¯·é‡è¯•");
    }
    
    // 4. æ’å…¥è¡¥åŠ©è®°å½•
    return stStudentSubsidyRecordMapper.insertStStudentSubsidyRecord(...);
}
```

**ä¼˜ç‚¹**ï¼š
- âœ… ä¸ä¼šé˜»å¡å…¶ä»–äº‹åŠ¡
- âœ… é€‚åˆè¯»å¤šå†™å°‘çš„åœºæ™¯
- âœ… æ€§èƒ½è¾ƒå¥½

**ç¼ºç‚¹**ï¼š
- âš ï¸ éœ€è¦å¤„ç†ç‰ˆæœ¬å†²çªï¼ˆé‡è¯•æœºåˆ¶ï¼‰
- âš ï¸ å®ç°ç›¸å¯¹å¤æ‚

**é€‚ç”¨åœºæ™¯**ï¼šè¯»å¤šå†™å°‘ï¼Œå¯ä»¥æ¥å—é‡è¯•çš„åœºæ™¯

---

### æ–¹æ¡ˆ3ï¼šåˆ†å¸ƒå¼é”ï¼ˆRedisï¼‰â­æ¨èï¼ˆåˆ†å¸ƒå¼åœºæ™¯ï¼‰

#### å®ç°æ–¹å¼
```java
@Service
public class BudgetLockService {
    
    @Autowired
    private RedisCache redisCache;
    
    private static final String LOCK_KEY_PREFIX = "budget:lock:";
    private static final int LOCK_EXPIRE_SECONDS = 30;
    
    /**
     * å°è¯•è·å–é¢„ç®—é”
     */
    public boolean tryLock(Long budgetId) {
        String lockKey = LOCK_KEY_PREFIX + budgetId;
        String lockValue = UUID.randomUUID().toString();
        
        // ä½¿ç”¨SETNXå®ç°åˆ†å¸ƒå¼é”
        Boolean success = redisCache.getRedisTemplate().opsForValue()
            .setIfAbsent(lockKey, lockValue, LOCK_EXPIRE_SECONDS, TimeUnit.SECONDS);
        
        return Boolean.TRUE.equals(success);
    }
    
    /**
     * é‡Šæ”¾é¢„ç®—é”
     */
    public void releaseLock(Long budgetId) {
        String lockKey = LOCK_KEY_PREFIX + budgetId;
        redisCache.deleteObject(lockKey);
    }
    
    /**
     * å¸¦é”çš„é¢„ç®—æ“ä½œ
     */
    @Transactional
    public int insertStStudentSubsidyRecordWithLock(...) {
        Long budgetId = stStudentSubsidyRecord.getBudgetId();
        
        try {
            // 1. è·å–åˆ†å¸ƒå¼é”
            if (!tryLock(budgetId)) {
                throw new ServiceException("é¢„ç®—æ­£åœ¨è¢«å…¶ä»–æ“ä½œä½¿ç”¨ï¼Œè¯·ç¨åé‡è¯•");
            }
            
            // 2. æŸ¥è¯¢é¢„ç®—
            StSemesterBudget budget = stSemesterBudgetMapper.selectStSemesterBudgetById(budgetId);
            
            // 3. éªŒè¯å’Œæ›´æ–°
            // ... ä¸šåŠ¡é€»è¾‘
            
        } finally {
            // 4. é‡Šæ”¾é”
            releaseLock(budgetId);
        }
    }
}
```

**ä¼˜ç‚¹**ï¼š
- âœ… é€‚åˆåˆ†å¸ƒå¼ç³»ç»Ÿ
- âœ… å¯ä»¥è®¾ç½®é”è¶…æ—¶ï¼Œé˜²æ­¢æ­»é”
- âœ… æ€§èƒ½è¾ƒå¥½

**ç¼ºç‚¹**ï¼š
- âš ï¸ éœ€è¦Redisæ”¯æŒ
- âš ï¸ éœ€è¦å¤„ç†é”è¶…æ—¶å’Œé‡Šæ”¾é—®é¢˜
- âš ï¸ å®ç°ç›¸å¯¹å¤æ‚

**é€‚ç”¨åœºæ™¯**ï¼šåˆ†å¸ƒå¼ç³»ç»Ÿï¼Œå¤šå®ä¾‹éƒ¨ç½²

---

### æ–¹æ¡ˆ4ï¼šæ•°æ®åº“è¡Œé”ï¼ˆå½“å‰SQLå·²éƒ¨åˆ†å®ç°ï¼‰

#### å½“å‰å®ç°åˆ†æ
```sql
-- å½“å‰SQLå·²ç»ä½¿ç”¨äº†WHEREæ¡ä»¶ï¼ŒMySQLä¼šè‡ªåŠ¨åŠ è¡Œé”
UPDATE st_semester_budget
SET locked_amount = COALESCE(locked_amount, 0) + #{amount}
WHERE id = #{budgetId}
AND (budget_amount - COALESCE(used_amount, 0) - COALESCE(locked_amount, 0)) >= #{amount}
```

**MySQL InnoDBçš„è¡Œé”æœºåˆ¶**ï¼š
- UPDATEè¯­å¥ä¼šè‡ªåŠ¨å¯¹åŒ¹é…çš„è¡ŒåŠ æ’ä»–é”ï¼ˆXé”ï¼‰
- å…¶ä»–äº‹åŠ¡çš„UPDATEä¼šè¢«é˜»å¡ï¼Œç›´åˆ°å½“å‰äº‹åŠ¡æäº¤

**å½“å‰å®ç°çš„ä¿æŠ¤ç¨‹åº¦**ï¼š
- âœ… éƒ¨åˆ†ä¿æŠ¤ï¼šUPDATEæ—¶æ£€æŸ¥å¯ç”¨é‡‘é¢
- âš ï¸ ä»æœ‰é£é™©ï¼šæŸ¥è¯¢å’ŒUPDATEä¹‹é—´æœ‰æ—¶é—´çª—å£

---

## å››ã€å¹¶å‘é—®é¢˜åœºæ™¯æµ‹è¯•

### æµ‹è¯•åœºæ™¯ï¼šä¸¤ä¸ªç”¨æˆ·åŒæ—¶ç”³è¯·è¡¥åŠ©

#### å½“å‰å®ç°ï¼ˆæ— é¢å¤–é”ï¼‰
```
æ—¶é—´ | ç”¨æˆ·A | ç”¨æˆ·B | é¢„ç®—çŠ¶æ€
-----|-------|-------|----------
T1   | æŸ¥è¯¢å¯ç”¨é‡‘é¢=10000 | | å¯ç”¨=10000
T2   | | æŸ¥è¯¢å¯ç”¨é‡‘é¢=10000 | å¯ç”¨=10000
T3   | UPDATEé”å®š5000 | | å¯ç”¨=5000,é”å®š=5000
T4   | | UPDATEé”å®š6000 | å¯ç”¨=-1000,é”å®š=11000 âŒè¶…æ”¯ï¼
```

#### ä½¿ç”¨æ‚²è§‚é”ï¼ˆSELECT FOR UPDATEï¼‰
```
æ—¶é—´ | ç”¨æˆ·A | ç”¨æˆ·B | é¢„ç®—çŠ¶æ€
-----|-------|-------|----------
T1   | SELECT FOR UPDATE | | è¡Œè¢«é”å®š
T2   | æŸ¥è¯¢å¯ç”¨é‡‘é¢=10000 | ç­‰å¾…... | å¯ç”¨=10000
T3   | UPDATEé”å®š5000 | ç­‰å¾…... | å¯ç”¨=5000,é”å®š=5000
T4   | COMMIT | è·å–é” | å¯ç”¨=5000,é”å®š=5000
T5   | | æŸ¥è¯¢å¯ç”¨é‡‘é¢=5000 | å¯ç”¨=5000
T6   | | UPDATEå¤±è´¥ï¼ˆä½™é¢ä¸è¶³ï¼‰ | å¯ç”¨=5000 âœ…æ­£ç¡®ï¼
```

---

## äº”ã€æ¨èæ–¹æ¡ˆï¼ˆç»“åˆå½“å‰é¡¹ç›®ï¼‰

### æ–¹æ¡ˆAï¼šæ‚²è§‚é” + äº‹åŠ¡éš”ç¦»çº§åˆ« â­â­â­â­â­ï¼ˆæœ€æ¨èï¼‰

#### å®ç°æ­¥éª¤

1. **ä¿®æ”¹Mapperï¼Œæ·»åŠ FOR UPDATEæŸ¥è¯¢**
```java
// StSemesterBudgetMapper.java
@Select("SELECT * FROM st_semester_budget WHERE id = #{id} FOR UPDATE")
StSemesterBudget selectStSemesterBudgetByIdForUpdate(Long id);
```

2. **ä¿®æ”¹Serviceï¼Œä½¿ç”¨æ‚²è§‚é”**
```java
@Transactional(isolation = Isolation.REPEATABLE_READ)  // å¯é‡å¤è¯»éš”ç¦»çº§åˆ«
public int insertStStudentSubsidyRecord(StStudentSubsidyRecord record) {
    // 1. ä½¿ç”¨æ‚²è§‚é”æŸ¥è¯¢é¢„ç®—
    StSemesterBudget budget = stSemesterBudgetMapper
        .selectStSemesterBudgetByIdForUpdate(record.getBudgetId());
    
    // 2. éªŒè¯å¯ç”¨é‡‘é¢
    BigDecimal available = budget.getBudgetAmount()
        .subtract(budget.getUsedAmount() != null ? budget.getUsedAmount() : BigDecimal.ZERO)
        .subtract(budget.getLockedAmount() != null ? budget.getLockedAmount() : BigDecimal.ZERO);
    
    if (available.compareTo(record.getSubsidyAmount()) < 0) {
        throw new ServiceException("é¢„ç®—ä½™é¢ä¸è¶³");
    }
    
    // 3. æ›´æ–°é”å®šé‡‘é¢ï¼ˆæ­¤æ—¶å…¶ä»–äº‹åŠ¡è¢«é˜»å¡ï¼‰
    int locked = stSemesterBudgetMapper.lockBudgetAmount(
        record.getBudgetId(), record.getSubsidyAmount()
    );
    
    if (locked == 0) {
        throw new ServiceException("é¢„ç®—ä½™é¢ä¸è¶³ï¼Œæ— æ³•ç”³è¯·è¡¥åŠ©");
    }
    
    // 4. æ’å…¥è¡¥åŠ©è®°å½•
    return stStudentSubsidyRecordMapper.insertStStudentSubsidyRecord(record);
}
```

**ä¼˜ç‚¹**ï¼š
- âœ… å®Œå…¨é˜²æ­¢å¹¶å‘é—®é¢˜
- âœ… å®ç°ç®€å•ï¼Œæ•°æ®åº“å±‚é¢ä¿è¯
- âœ… é€‚åˆå½“å‰é¡¹ç›®æ¶æ„

---

### æ–¹æ¡ˆBï¼šä¹è§‚é” + é‡è¯•æœºåˆ¶ â­â­â­â­

é€‚åˆè¯»å¤šå†™å°‘çš„åœºæ™¯ï¼Œéœ€è¦æ·»åŠ versionå­—æ®µå’Œé‡è¯•é€»è¾‘ã€‚

---

### æ–¹æ¡ˆCï¼šåˆ†å¸ƒå¼é”ï¼ˆRedisï¼‰ â­â­â­

é€‚åˆåˆ†å¸ƒå¼ç³»ç»Ÿï¼Œéœ€è¦Redisæ”¯æŒã€‚

---

## å…­ã€å¤šçº¿ç¨‹åœºæ™¯åˆ†æ

### å½“å‰é¡¹ç›®çš„å¤šçº¿ç¨‹åœºæ™¯

1. **Webè¯·æ±‚å¹¶å‘**ï¼šå¤šä¸ªç”¨æˆ·åŒæ—¶æäº¤è¡¥åŠ©ç”³è¯·
2. **å®šæ—¶ä»»åŠ¡**ï¼šå¯èƒ½åŒæ—¶æ‰§è¡Œæ•°æ®ä¿®å¤ä»»åŠ¡
3. **æ‰¹é‡æ“ä½œ**ï¼šExcelå¯¼å…¥ã€æ‰¹é‡å‘æ”¾ç­‰

### çº¿ç¨‹å®‰å…¨é—®é¢˜

#### 1. é¢„ç®—é”å®šé‡‘é¢æ›´æ–°
- **é£é™©**ï¼šé«˜ âš ï¸âš ï¸âš ï¸
- **åŸå› **ï¼šå¤šä¸ªçº¿ç¨‹åŒæ—¶æ›´æ–°åŒä¸€é¢„ç®—çš„é”å®šé‡‘é¢
- **è§£å†³æ–¹æ¡ˆ**ï¼šæ‚²è§‚é”æˆ–ä¹è§‚é”

#### 2. é¢„ç®—æŸ¥è¯¢
- **é£é™©**ï¼šä½ âœ…
- **åŸå› **ï¼šåªè¯»æ“ä½œï¼Œä¸æ¶‰åŠæ•°æ®ä¿®æ”¹
- **è§£å†³æ–¹æ¡ˆ**ï¼šå½“å‰å®ç°å·²è¶³å¤Ÿ

#### 3. æ•°æ®ä¿®å¤ä»»åŠ¡
- **é£é™©**ï¼šä¸­ âš ï¸
- **åŸå› **ï¼šå¯èƒ½ä¸ä¸šåŠ¡æ“ä½œå†²çª
- **è§£å†³æ–¹æ¡ˆ**ï¼šä½¿ç”¨åˆ†å¸ƒå¼é”æˆ–å®šæ—¶ä»»åŠ¡é”

---

## ä¸ƒã€å®æ–½å»ºè®®

### çŸ­æœŸï¼ˆç«‹å³å®æ–½ï¼‰â­
1. **æ·»åŠ æ‚²è§‚é”ï¼ˆSELECT FOR UPDATEï¼‰**
   - åœ¨å…³é”®æ“ä½œä¸­ä½¿ç”¨FOR UPDATE
   - è®¾ç½®åˆé€‚çš„äº‹åŠ¡éš”ç¦»çº§åˆ«

### ä¸­æœŸï¼ˆæ€§èƒ½ä¼˜åŒ–ï¼‰
2. **æ·»åŠ Redisåˆ†å¸ƒå¼é”**ï¼ˆå¦‚æœæœ‰å¤šå®ä¾‹ï¼‰
   - é˜²æ­¢å¤šå®ä¾‹ä¹‹é—´çš„å¹¶å‘é—®é¢˜
   - æå‡ç³»ç»Ÿå¯æ‰©å±•æ€§

### é•¿æœŸï¼ˆæ¶æ„ä¼˜åŒ–ï¼‰
3. **è€ƒè™‘ä¹è§‚é”**ï¼ˆå¦‚æœè¯»å¤šå†™å°‘ï¼‰
   - å‡å°‘é”ç«äº‰
   - æå‡å¹¶å‘æ€§èƒ½

---

## å…«ã€æ€§èƒ½å½±å“è¯„ä¼°

| æ–¹æ¡ˆ | å¹¶å‘æ€§èƒ½ | æ•°æ®å®‰å…¨æ€§ | å®ç°å¤æ‚åº¦ | æ¨èåº¦ |
|------|---------|-----------|-----------|--------|
| å½“å‰å®ç° | â­â­â­ | â­â­ | â­ | â­â­ |
| æ‚²è§‚é” | â­â­ | â­â­â­â­â­ | â­â­ | â­â­â­â­â­ |
| ä¹è§‚é” | â­â­â­â­ | â­â­â­â­ | â­â­â­ | â­â­â­â­ |
| åˆ†å¸ƒå¼é” | â­â­â­ | â­â­â­â­ | â­â­â­â­ | â­â­â­ |

---

## ä¹ã€æ€»ç»“

**å½“å‰å®ç°å­˜åœ¨çš„é—®é¢˜**ï¼š
- âš ï¸ å­˜åœ¨å¹¶å‘è¶…æ”¯é£é™©
- âš ï¸ æŸ¥è¯¢å’Œæ›´æ–°ä¹‹é—´æœ‰ç«æ€æ¡ä»¶

**æ¨èæ–¹æ¡ˆ**ï¼š
- âœ… **æ‚²è§‚é”ï¼ˆSELECT FOR UPDATEï¼‰** - æœ€é€‚åˆå½“å‰åœºæ™¯
- âœ… è®¾ç½®äº‹åŠ¡éš”ç¦»çº§åˆ«ä¸º `REPEATABLE_READ`
- âœ… åœ¨å…³é”®æ“ä½œä¸­ä½¿ç”¨FOR UPDATE

**å®æ–½ä¼˜å…ˆçº§**ï¼š
1. ğŸ”´ **é«˜ä¼˜å…ˆçº§**ï¼šæ·»åŠ æ‚²è§‚é”ï¼Œé˜²æ­¢å¹¶å‘è¶…æ”¯
2. ğŸŸ¡ **ä¸­ä¼˜å…ˆçº§**ï¼šæ·»åŠ Redisåˆ†å¸ƒå¼é”ï¼ˆå¦‚æœå¤šå®ä¾‹ï¼‰
3. ğŸŸ¢ **ä½ä¼˜å…ˆçº§**ï¼šè€ƒè™‘ä¹è§‚é”ä¼˜åŒ–ï¼ˆå¦‚æœæ€§èƒ½æˆä¸ºç“¶é¢ˆï¼‰

