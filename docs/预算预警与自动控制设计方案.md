# 预算预警与自动控制设计方案

## 一、设计目标

1. **预警机制**：预算余额低于阈值时自动预警
2. **自动控制**：余额不足时自动冻结预算，防止超支
3. **使用率监控**：实时监控预算使用率，生成预警报告
4. **通知机制**：及时通知相关管理员

---

## 二、数据库设计

### 2.1 预警规则配置表 `st_budget_warning_rule`

```sql
CREATE TABLE `st_budget_warning_rule` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `rule_name` varchar(100) NOT NULL COMMENT '规则名称',
  `warning_type` varchar(20) NOT NULL COMMENT '预警类型：USAGE_RATE(使用率), AVAILABLE_AMOUNT(可用金额)',
  `threshold_type` varchar(20) NOT NULL COMMENT '阈值类型：PERCENTAGE(百分比), AMOUNT(金额)',
  `threshold_value` decimal(18, 2) NOT NULL COMMENT '阈值（百分比或金额）',
  `warning_level` varchar(20) NOT NULL COMMENT '预警级别：LOW(低), MEDIUM(中), HIGH(高), CRITICAL(严重)',
  `auto_freeze` tinyint(1) DEFAULT 0 COMMENT '是否自动冻结：0否,1是',
  `freeze_threshold` decimal(18, 2) DEFAULT NULL COMMENT '自动冻结阈值（可用金额）',
  `notification_enabled` tinyint(1) DEFAULT 1 COMMENT '是否启用通知：0否,1是',
  `notification_users` text COMMENT '通知用户ID列表（JSON数组）',
  `status` int DEFAULT 1 COMMENT '状态：1启用,0禁用',
  `memo` text COMMENT '备注',
  `created_at` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  INDEX `idx_status` (`status`)
) COMMENT='预算预警规则配置表';
```

**预警类型说明**：
- `USAGE_RATE`：按使用率预警（如：使用率达到80%时预警）
- `AVAILABLE_AMOUNT`：按可用金额预警（如：可用金额低于1000元时预警）

**预警级别说明**：
- `LOW`：低（使用率50-70%）
- `MEDIUM`：中（使用率70-85%）
- `HIGH`：高（使用率85-95%）
- `CRITICAL`：严重（使用率>95%或可用金额<=0）

### 2.2 预警记录表 `st_budget_warning_log`

```sql
CREATE TABLE `st_budget_warning_log` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `budget_id` bigint NOT NULL COMMENT '预算ID',
  `rule_id` bigint COMMENT '预警规则ID',
  `warning_type` varchar(20) NOT NULL COMMENT '预警类型',
  `warning_level` varchar(20) NOT NULL COMMENT '预警级别',
  `budget_amount` decimal(18, 2) NOT NULL COMMENT '预算总额',
  `used_amount` decimal(18, 2) NOT NULL COMMENT '已使用金额',
  `locked_amount` decimal(18, 2) NOT NULL COMMENT '锁定金额',
  `available_amount` decimal(18, 2) NOT NULL COMMENT '可用金额',
  `usage_rate` decimal(5, 2) NOT NULL COMMENT '使用率（百分比）',
  `threshold_value` decimal(18, 2) NOT NULL COMMENT '触发阈值',
  `warning_message` text COMMENT '预警消息',
  `is_handled` tinyint(1) DEFAULT 0 COMMENT '是否已处理：0否,1是',
  `handled_by` varchar(64) COMMENT '处理人',
  `handled_at` datetime COMMENT '处理时间',
  `created_at` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`),
  INDEX `idx_budget_id` (`budget_id`),
  INDEX `idx_warning_level` (`warning_level`),
  INDEX `idx_is_handled` (`is_handled`),
  INDEX `idx_created_at` (`created_at`)
) COMMENT='预算预警记录表';
```

### 2.3 预算表增加字段（可选）

如果需要记录预警状态，可以在 `st_semester_budget` 表增加：

```sql
ALTER TABLE `st_semester_budget` 
ADD COLUMN `warning_status` varchar(20) DEFAULT NULL COMMENT '预警状态：NORMAL(正常), WARNING(预警), CRITICAL(严重)',
ADD COLUMN `last_warning_time` datetime DEFAULT NULL COMMENT '最后预警时间';
```

---

## 三、核心功能设计

### 3.1 预警规则配置管理

#### 3.1.1 默认预警规则

系统初始化时创建默认规则：

1. **使用率预警规则**
   - 低预警：使用率 >= 70%
   - 中预警：使用率 >= 85%
   - 高预警：使用率 >= 95%
   - 严重预警：使用率 >= 99%

2. **可用金额预警规则**
   - 低预警：可用金额 <= 预算总额的10%
   - 中预警：可用金额 <= 预算总额的5%
   - 高预警：可用金额 <= 1000元
   - 严重预警：可用金额 <= 0元（自动冻结）

#### 3.1.2 规则配置界面

- 支持创建、编辑、删除预警规则
- 支持启用/禁用规则
- 支持配置通知用户列表

### 3.2 预警触发机制

#### 3.2.1 实时预警（事件驱动）

在以下操作后触发预警检查：

1. **补助录入时**：锁定预算金额后
2. **审批通过时**：更新已使用金额后
3. **审批驳回时**：释放锁定金额后
4. **预算创建/修改时**：预算金额变更后

#### 3.2.2 定时预警（定时任务）

每天定时检查所有预算的预警状态：

```java
@Scheduled(cron = "0 0 9 * * ?") // 每天上午9点
public void checkBudgetWarnings() {
    // 检查所有启用状态的预算
    // 根据预警规则判断是否需要预警
}
```

### 3.3 预警检查逻辑

```java
public class BudgetWarningService {
    
    /**
     * 检查预算是否需要预警
     */
    public void checkBudgetWarning(Long budgetId) {
        StSemesterBudget budget = budgetMapper.selectById(budgetId);
        if (budget == null || budget.getStatus() == 4) {
            return; // 预算不存在或已作废
        }
        
        // 计算使用率和可用金额
        BigDecimal budgetAmount = budget.getBudgetAmount();
        BigDecimal usedAmount = budget.getUsedAmount();
        BigDecimal lockedAmount = budget.getLockedAmount();
        BigDecimal availableAmount = budgetAmount.subtract(usedAmount).subtract(lockedAmount);
        BigDecimal usageRate = budgetAmount.compareTo(BigDecimal.ZERO) > 0 
            ? usedAmount.add(lockedAmount).divide(budgetAmount, 4, RoundingMode.HALF_UP)
                .multiply(new BigDecimal("100"))
            : BigDecimal.ZERO;
        
        // 获取所有启用的预警规则
        List<BudgetWarningRule> rules = ruleMapper.selectEnabledRules();
        
        for (BudgetWarningRule rule : rules) {
            boolean shouldWarn = false;
            String warningLevel = null;
            
            if ("USAGE_RATE".equals(rule.getWarningType())) {
                // 使用率预警
                if (usageRate.compareTo(rule.getThresholdValue()) >= 0) {
                    shouldWarn = true;
                    warningLevel = rule.getWarningLevel();
                }
            } else if ("AVAILABLE_AMOUNT".equals(rule.getWarningType())) {
                // 可用金额预警
                if (availableAmount.compareTo(rule.getThresholdValue()) <= 0) {
                    shouldWarn = true;
                    warningLevel = rule.getWarningLevel();
                }
            }
            
            if (shouldWarn) {
                // 创建预警记录
                createWarningLog(budget, rule, usageRate, availableAmount);
                
                // 发送通知
                if (rule.getNotificationEnabled()) {
                    sendNotification(budget, rule, warningLevel);
                }
                
                // 自动冻结检查
                if (rule.getAutoFreeze() && availableAmount.compareTo(rule.getFreezeThreshold()) <= 0) {
                    autoFreezeBudget(budgetId);
                }
            }
        }
    }
}
```

### 3.4 自动冻结机制

```java
/**
 * 自动冻结预算
 */
public void autoFreezeBudget(Long budgetId) {
    StSemesterBudget budget = budgetMapper.selectById(budgetId);
    if (budget == null || budget.getStatus() == 2) {
        return; // 已冻结或不存在
    }
    
    // 更新预算状态为冻结
    budgetMapper.updateStatus(budgetId, 2); // 2=冻结
    
    // 记录操作日志
    log.info("预算ID={}因余额不足自动冻结", budgetId);
    
    // 发送冻结通知
    sendFreezeNotification(budget);
}
```

### 3.5 通知机制

#### 3.5.1 通知方式

1. **站内消息**：系统内消息通知
2. **邮件通知**：发送邮件给管理员
3. **短信通知**：发送短信（可选，需要短信服务）

#### 3.5.2 通知内容

```
【预算预警通知】
预算项目：XXX助学金
预算总额：100,000.00元
已使用金额：95,000.00元
锁定金额：3,000.00元
可用金额：2,000.00元
使用率：98.00%
预警级别：严重
预警时间：2025-01-15 10:30:00

请及时处理！
```

---

## 四、实现步骤

### 阶段一：基础功能（1-2周）

1. 创建数据库表
2. 实现预警规则配置管理（CRUD）
3. 实现预警检查逻辑
4. 实现预警记录查询

### 阶段二：自动控制（1周）

1. 实现自动冻结功能
2. 在补助录入/审批时集成预警检查
3. 实现定时预警任务

### 阶段三：通知功能（1周）

1. 实现站内消息通知
2. 实现邮件通知（可选）
3. 实现通知配置管理

### 阶段四：前端界面（1周）

1. 预警规则配置页面
2. 预警记录查询页面
3. 预算列表显示预警状态
4. 预警统计图表

---

## 五、使用场景示例

### 场景1：补助录入时预警

```
用户录入补助，金额5000元
→ 系统锁定预算金额
→ 检查预算可用金额
→ 如果可用金额 < 1000元，触发严重预警
→ 如果可用金额 <= 0，自动冻结预算
→ 发送预警通知给管理员
```

### 场景2：定时预警检查

```
每天上午9点执行定时任务
→ 检查所有启用状态的预算
→ 计算使用率和可用金额
→ 根据预警规则判断是否需要预警
→ 创建预警记录
→ 发送通知
```

### 场景3：预算使用率监控

```
管理员查看预算列表
→ 显示每个预算的使用率
→ 使用率 >= 95% 的预算显示红色预警标识
→ 点击查看预警历史记录
```

---

## 六、配置建议

### 6.1 默认预警规则配置

建议创建以下默认规则：

1. **使用率预警**
   - 中预警：使用率 >= 80%，不自动冻结
   - 高预警：使用率 >= 90%，不自动冻结
   - 严重预警：使用率 >= 95%，不自动冻结

2. **可用金额预警**
   - 高预警：可用金额 <= 5000元，不自动冻结
   - 严重预警：可用金额 <= 0元，**自动冻结**

### 6.2 通知用户配置

建议通知以下角色：
- 财务管理员
- 资助办主任
- 预算创建人

---

## 七、注意事项

1. **性能考虑**：预警检查不应影响正常业务流程，建议异步处理
2. **重复预警**：同一预算在同一级别下，24小时内只预警一次
3. **自动冻结可逆**：自动冻结的预算，管理员可以手动解冻
4. **预警记录保留**：预警记录建议保留至少1年，用于审计
5. **阈值合理性**：预警阈值需要根据实际业务情况调整

---

## 八、扩展功能（可选）

1. **预警统计报表**：统计各预警级别的预算数量
2. **预警趋势分析**：分析预算使用趋势，预测何时会触发预警
3. **预警规则模板**：提供不同场景的预警规则模板
4. **移动端推送**：支持移动端推送预警通知


