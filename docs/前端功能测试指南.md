# 预算锁定金额并发控制 - 前端功能测试指南

## 一、测试目标

验证在并发场景下，预算锁定金额是否正确，不会出现超支问题。

---

## 二、测试场景

### 场景1：多用户同时录入补助（测试并发锁定）

**测试步骤：**

1. **准备数据**
   - 创建一个预算，可用金额设置为 `10000` 元
   - 准备2个学生，每人需要 `6000` 元补助

2. **模拟并发操作**
   - 打开两个浏览器窗口（或使用无痕模式）
   - 两个窗口都登录系统
   - 窗口A：选择学生1，录入补助 `6000` 元
   - 窗口B：同时选择学生2，录入补助 `6000` 元
   - 两个窗口几乎同时点击"提交"

3. **预期结果**
   - ✅ 第一个提交成功：录入成功，待审核
   - ✅ 第二个提交失败：提示"预算余额不足"或"预算正在被其他操作使用，请稍后重试"
   - ✅ 预算锁定金额 = `6000` 元（只有第一个成功）
   - ✅ 预算可用余额 = `4000` 元（10000 - 6000）

4. **验证方法**
   - 查看"学期预算"列表，检查锁定金额是否正确
   - 查看补助记录，确认只有一条记录创建成功

---

### 场景2：批量发放并发测试

**测试步骤：**

1. **准备数据**
   - 创建一个预算，可用金额设置为 `5000` 元
   - 准备3个学生，每人需要 `2000` 元补助

2. **模拟并发操作**
   - 打开两个浏览器窗口
   - 窗口A：批量发放，选择学生1和学生2（共4000元）
   - 窗口B：同时批量发放，选择学生3（2000元）
   - 两个窗口几乎同时点击"提交"

3. **预期结果**
   - ✅ 第一个提交成功：2人录入成功，待审核
   - ✅ 第二个提交失败：提示"预算余额不足"或"预算正在被其他操作使用"
   - ✅ 预算锁定金额 = `4000` 元
   - ✅ 预算可用余额 = `1000` 元

---

### 场景3：Excel导入并发测试

**测试步骤：**

1. **准备数据**
   - 创建一个预算，可用金额设置为 `8000` 元
   - 准备两个Excel文件：
     - Excel A：包含2个学生，每人 `5000` 元（共10000元，会超支）
     - Excel B：包含1个学生，`3000` 元

2. **模拟并发操作**
   - 打开两个浏览器窗口
   - 窗口A：上传Excel A
   - 窗口B：同时上传Excel B
   - 两个窗口几乎同时点击"导入"

3. **预期结果**
   - ✅ 第一个导入：如果Excel A先执行，应该失败（余额不足）
   - ✅ 第二个导入：如果Excel B先执行，应该成功，Excel A失败
   - ✅ 预算锁定金额 = `3000` 元（Excel B成功的情况）
   - ✅ 预算可用余额 = `5000` 元

---

### 场景4：验证锁定金额统计（历史数据）

**测试步骤：**

1. **准备数据**
   - 创建一个预算，可用金额设置为 `10000` 元
   - 创建2条未审批的补助记录，每人 `1000` 元（共2000元）

2. **验证操作**
   - 打开"学期预算"列表
   - 查看该预算的"锁定金额"列

3. **预期结果**
   - ✅ 锁定金额显示 = `2000` 元（包含所有未审批记录）
   - ✅ 可用余额 = `8000` 元（10000 - 2000）

4. **继续测试**
   - 再创建一条新的未审批记录，`1000` 元
   - 刷新预算列表
   - ✅ 锁定金额应该更新为 `3000` 元

---

## 三、快速测试方法

### 方法1：使用浏览器多窗口（最简单）

1. 打开Chrome浏览器
2. 正常窗口登录系统
3. 按 `Ctrl+Shift+N` 打开无痕窗口，再次登录
4. 两个窗口同时操作，测试并发

### 方法2：使用Postman/Apache Bench（模拟并发请求）

**使用Postman Runner：**
1. 创建请求：POST `/system/subsidyRecord`
2. 设置请求体（补助记录数据）
3. 在Runner中设置：
   - Iterations: 5（5次请求）
   - Delay: 0（无延迟，模拟并发）
4. 点击Run，观察结果

**使用Apache Bench：**
```bash
# 安装Apache Bench（Windows需要安装Apache）
ab -n 10 -c 5 -p request.json -T application/json http://localhost:8080/system/subsidyRecord
```

---

## 四、测试检查点

### ✅ 功能检查

- [ ] 并发提交时，只有一个请求成功
- [ ] 失败的请求提示明确的错误信息
- [ ] 预算锁定金额正确统计
- [ ] 预算可用余额计算正确
- [ ] 历史未审批记录的锁定金额也被统计

### ✅ 错误提示检查

- [ ] 获取锁失败时，提示："预算正在被其他操作使用，请稍后重试"
- [ ] 余额不足时，提示："预算余额不足，无法申请补助"
- [ ] 提示信息清晰，用户能理解

### ✅ 数据一致性检查

- [ ] 锁定金额 = 所有未审批记录的金额总和
- [ ] 可用余额 = 预算总额 - 已用金额 - 锁定金额
- [ ] 不会出现负数余额
- [ ] 不会出现超支情况

---

## 五、常见问题排查

### 问题1：两个请求都成功了（不应该发生）

**检查：**
- 查看后端日志，确认是否获取到分布式锁
- 检查Redis是否正常运行
- 检查锁的超时时间是否设置合理

### 问题2：锁定金额显示为0

**检查：**
- 查看后端日志，确认是否调用了锁定方法
- 检查数据库，确认 `locked_amount` 字段是否有值
- 刷新页面，确认是否使用了动态计算

### 问题3：提示"预算正在被其他操作使用"

**这是正常的！**
- 说明分布式锁生效了
- 等待几秒后重试即可
- 或者先完成第一个操作，再执行第二个

---

## 六、测试数据准备SQL

```sql
-- 1. 创建一个测试预算（可用金额10000元）
-- 假设预算ID为1，需要根据实际情况修改

-- 2. 查看预算当前状态
SELECT 
    id,
    budget_amount AS 预算总额,
    used_amount AS 已用金额,
    locked_amount AS 锁定金额,
    (budget_amount - COALESCE(used_amount, 0) - COALESCE(locked_amount, 0)) AS 可用余额
FROM st_semester_budget
WHERE id = 1;

-- 3. 查看未审批的补助记录（应该等于锁定金额）
SELECT 
    budget_id,
    COUNT(*) AS 记录数,
    SUM(subsidy_amount) AS 总金额
FROM st_student_subsidy_records
WHERE budget_id = 1
AND approval_status = 0
GROUP BY budget_id;

-- 4. 清理测试数据（测试完成后）
-- DELETE FROM st_student_subsidy_records WHERE budget_id = 1 AND approval_status = 0;
```

---

## 七、测试报告模板

```
测试时间：2024-XX-XX
测试人员：XXX
测试环境：开发环境

测试场景1：多用户同时录入
- 结果：✅ 通过 / ❌ 失败
- 说明：第一个成功，第二个提示"预算正在被其他操作使用"

测试场景2：批量发放并发
- 结果：✅ 通过 / ❌ 失败
- 说明：...

测试场景3：锁定金额统计
- 结果：✅ 通过 / ❌ 失败
- 说明：历史未审批记录也被正确统计

问题记录：
1. ...
2. ...
```

---

## 八、快速验证清单

- [ ] 打开两个浏览器窗口
- [ ] 同时提交补助申请
- [ ] 检查只有一个成功
- [ ] 检查预算锁定金额是否正确
- [ ] 检查错误提示是否友好
- [ ] 验证历史数据也被统计

**完成以上检查，说明并发控制机制正常工作！** ✅

