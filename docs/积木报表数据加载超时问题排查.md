# 积木报表数据加载超时问题排查

## 问题描述

报表页面可以加载，但是数据显示超时（60秒后提示超时）。

## 可能原因

1. **SQL查询执行时间过长**
   - 数据集SQL太复杂
   - 表连接太多
   - 缺少索引

2. **参数传递问题**
   - `studentId` 参数未正确传递
   - 参数类型不匹配

3. **数据不存在**
   - 学生ID不存在
   - 学生数据不完整

4. **数据集配置问题**
   - SQL语法错误
   - 数据集参数配置错误

## 排查步骤

### 步骤1：在新窗口中打开查看详细错误

1. 点击"新窗口打开"按钮
2. 打开浏览器开发者工具（F12）
3. 查看Console标签页的错误信息
4. 查看Network标签页，看哪个请求失败了

### 步骤2：验证参数传递

1. 在新窗口的URL中，检查 `studentId` 参数是否正确
   - 例如：`http://localhost:8080/jmreport/view/1159821341794144256?studentId=2`
   - 确认 `studentId=2` 是正确传递的

2. 在积木报表的数据集配置中，确认参数名称是 `studentId`（区分大小写）

### 步骤3：测试SQL查询

直接在数据库中执行SQL查询，验证：

```sql
-- 替换 ${studentId} 为实际的学生ID，例如 2
SELECT
    s.id AS student_id,
    s.name AS name,
    -- ... 其他字段
FROM st_students_base s
LEFT JOIN st_grades g ON s.grade_id = g.id
LEFT JOIN st_class_info c ON s.class_id = c.class_id
LEFT JOIN st_student_bank_cards b ON s.id = b.student_id AND b.is_primary = 1 AND b.status = 0
LEFT JOIN sys_dict_data dict_eth ON dict_eth.dict_type = 'sys_student_ethnicity' AND dict_eth.dict_value = s.ethnicity AND dict_eth.status = '0'
LEFT JOIN sys_dict_data dict_difficulty ON dict_difficulty.dict_type = 'sys_difficulty_type' AND dict_difficulty.dict_value = s.difficulty_type_id AND dict_difficulty.status = '0'
LEFT JOIN sys_dict_data dict_level ON dict_level.dict_type = 'sys_difficulty_level' AND dict_level.dict_value = s.difficulty_level_id AND dict_level.status = '0'
WHERE s.id = 2  -- 替换为实际的学生ID
```

**检查点**：
- 查询是否能正常执行
- 是否返回数据
- 执行时间是多少（如果超过5秒，可能需要优化）

### 步骤4：检查积木报表数据集配置

1. 进入积木报表设计器
2. 打开"普通高中国家助学金申请表"
3. 检查数据集配置：
   - **数据集名称**：`student_info`
   - **数据源类型**：SQL
   - **参数配置**：确认有 `studentId` 参数，类型为 `Integer` 或 `String`
   - **SQL语句**：确认使用 `${studentId}` 占位符

### 步骤5：简化SQL测试

如果SQL太复杂，可以先测试一个简化版本：

```sql
SELECT
    s.id,
    s.name,
    s.student_no
FROM st_students_base s
WHERE s.id = ${studentId}
```

如果简化版本能正常显示，再逐步添加字段。

## 常见问题和解决方案

### 问题1：参数未传递

**症状**：报表显示空白或SQL错误

**解决方案**：
1. 确认URL中有 `?studentId=2`
2. 确认数据集参数名称是 `studentId`（区分大小写）
3. 确认参数类型匹配

### 问题2：SQL语法错误

**症状**：积木报表控制台显示SQL错误

**解决方案**：
1. 使用"干净版"SQL（无注释版本）
2. 检查SQL语句中是否有特殊字符
3. 确认所有表名和字段名正确

### 问题3：数据不存在

**症状**：查询无结果

**解决方案**：
1. 确认学生ID存在
2. 确认学生数据完整（有基本信息、年级班级、银行卡等）
3. 如果数据不完整，需要补充数据

### 问题4：查询太慢

**症状**：查询超过60秒

**解决方案**：
1. 检查是否有索引：
   ```sql
   -- 检查索引
   SHOW INDEX FROM st_students_base;
   SHOW INDEX FROM st_grades;
   SHOW INDEX FROM st_class_info;
   SHOW INDEX FROM st_student_bank_cards;
   ```

2. 添加必要的索引：
   ```sql
   -- 如果缺少索引，添加索引
   ALTER TABLE st_students_base ADD INDEX idx_grade_id (grade_id);
   ALTER TABLE st_students_base ADD INDEX idx_class_id (class_id);
   ALTER TABLE st_student_bank_cards ADD INDEX idx_student_primary (student_id, is_primary, status);
   ```

3. 优化SQL：
   - 减少不必要的JOIN
   - 使用INNER JOIN替代LEFT JOIN（如果数据一定存在）
   - 减少CASE WHEN的复杂度

## 快速验证方法

1. **直接访问报表URL**：
   ```
   http://localhost:8080/jmreport/view/1159821341794144256?studentId=2
   ```

2. **查看浏览器控制台**：
   - 按F12打开开发者工具
   - 查看Console标签页的错误信息
   - 查看Network标签页的请求状态

3. **检查后端日志**：
   - 查看后端控制台是否有SQL错误
   - 查看是否有异常堆栈信息

## 建议的调试流程

1. ✅ 在新窗口中打开报表（已经可以）
2. ✅ 查看浏览器控制台错误
3. ✅ 在数据库中直接执行SQL验证
4. ✅ 检查数据集参数配置
5. ✅ 如果SQL慢，优化SQL或添加索引
6. ✅ 如果数据不存在，补充学生数据

## 如果仍然无法解决

请提供以下信息：
1. 浏览器控制台的完整错误信息
2. 后端日志中的错误信息
3. 直接执行SQL的结果和执行时间
4. 学生ID和对应的数据是否存在

