# 上期结余计算优化方案

## 一、当前设计问题分析

### 1.1 现有实现方式
当前通过 `memo` 字段的文本匹配来判断是否是结转资金：
```sql
WHERE d.memo LIKE CONCAT('%从指标%结转%')
```

### 1.2 存在的问题

1. **不够严谨**：依赖文本字段的模糊匹配，容易被误判或篡改
2. **维护困难**：如果 memo 格式变化，SQL 查询逻辑需要同步修改
3. **数据完整性差**：无法建立明确的结转关系链，难以追溯资金流向
4. **性能问题**：LIKE 查询无法使用索引，在大数据量下性能较差
5. **业务逻辑混乱**：memo 字段本应作为备注信息，却被用作业务标识

## 二、优化方案设计

### 2.1 核心思路
**在明细表中添加 `source_detail_id` 字段，明确记录结转来源关系**

### 2.2 数据库设计变更

#### 2.2.1 表结构修改
在 `st_subsidy_quota_detail` 表中添加字段：

```sql
ALTER TABLE st_subsidy_quota_detail 
ADD COLUMN source_detail_id BIGINT NULL COMMENT '来源明细ID（结转时记录来源明细的ID，NULL表示非结转资金）' AFTER quota_id;

-- 添加索引以提升查询性能
CREATE INDEX idx_source_detail_id ON st_subsidy_quota_detail(source_detail_id);
```

#### 2.2.2 字段说明

| 字段名 | 类型 | 可空 | 说明 | 备注 |
|--------|------|------|------|------|
| `source_detail_id` | BIGINT | 是 | 来源明细ID | NULL表示非结转资金，有值表示从该明细结转而来 |

### 2.3 业务逻辑变更

#### 2.3.1 结转操作逻辑
当执行结转操作时：
1. **创建新明细**：设置 `source_detail_id = 来源明细的ID`
2. **更新已存在明细**：如果目标指标已有该经济分类的明细，需要记录部分金额的来源

**注意**：如果目标指标已有明细，且需要增加结转资金，有两种处理方式：
- **方案A（推荐）**：创建新的明细记录，分别记录原始金额和结转金额
- **方案B**：在现有明细上增加金额，但需要额外记录结转金额（可能需要拆分记录）

#### 2.3.2 上期结余计算逻辑

**历史学期**：
```sql
-- 显示剩余额度（保持不变）
total_amount - allocated_amount
```

**当前学期或未来学期**：
```sql
-- 只统计 source_detail_id 不为 NULL 的明细总金额
SELECT SUM(total_amount) 
FROM st_subsidy_quota_detail 
WHERE quota_id = ? 
  AND source_detail_id IS NOT NULL
```

### 2.4 数据迁移方案

对于现有数据，需要区分：
1. **已明确标记为结转的明细**：通过查询 `memo LIKE '%从指标%结转%'` 找到这些记录
2. **需要补充 source_detail_id**：根据指标主表的 `source_quota_id` 和明细的经济分类，匹配来源明细

**迁移SQL示例**：
```sql
-- 第一步：找到所有需要标记的明细（指标来源类型为结转，且明细memo包含"结转"）
UPDATE st_subsidy_quota_detail d
INNER JOIN st_subsidy_quota q ON d.quota_id = q.id
INNER JOIN st_subsidy_quota source_quota ON q.source_quota_id = source_quota.id
INNER JOIN st_subsidy_quota_detail source_detail 
    ON source_detail.quota_id = source_quota.id 
    AND source_detail.economy_category = d.economy_category
SET d.source_detail_id = source_detail.id
WHERE q.quota_source_type IN (2, 3)
  AND q.source_quota_id IS NOT NULL
  AND d.memo LIKE '%从指标%结转%'
  AND d.source_detail_id IS NULL;
```

## 三、实施步骤

### 3.1 数据库变更
1. 执行 ALTER TABLE 添加 `source_detail_id` 字段
2. 创建索引
3. 执行数据迁移SQL（如果有历史数据）

### 3.2 代码变更

#### 3.2.1 实体类修改
- `StSubsidyQuotaDetail.java`：添加 `sourceDetailId` 字段及 getter/setter

#### 3.2.2 Mapper 修改
- `StSubsidyQuotaDetailMapper.xml`：在 resultMap 中添加字段映射
- 修改插入和更新语句，支持 `source_detail_id` 字段

#### 3.2.3 Service 层修改
- `StSubsidyQuotaServiceImpl.carryOverToTargetQuota()`：
  - 创建新明细时，设置 `sourceDetailId = sourceDetail.getId()`
  - 更新已存在明细时，根据业务需求选择方案A或B

#### 3.2.4 SQL 查询修改
- `StSubsidyQuotaMapper.xml`：
  - 修改 `carry_over_amount` 计算逻辑，使用 `source_detail_id IS NOT NULL` 替代 memo 匹配

## 四、方案对比

### 4.1 方案A：创建新明细记录（推荐）

**优点**：
- 数据清晰，每条记录都有明确的来源
- 可以追溯每笔资金的完整流向
- 便于审计和统计

**缺点**：
- 同一指标同一经济分类可能有多个明细记录
- 需要在前端展示时合并显示

**适用场景**：需要完整追溯资金流向，对数据准确性要求高

### 4.2 方案B：更新现有明细，记录部分金额来源

**优点**：
- 保持一个指标一个经济分类只有一个明细
- 前端展示简单

**缺点**：
- 无法准确区分原始金额和结转金额
- 如果多次结转，难以追溯

**适用场景**：对追溯要求不高，更注重展示简洁

## 五、推荐方案

**推荐使用方案A**，原因：
1. 数据完整性更好
2. 符合财务审计要求
3. 便于后续扩展（如需要查看结转历史）

## 六、注意事项

1. **向后兼容**：迁移期间，可以同时支持 memo 匹配和 source_detail_id 判断
2. **数据一致性**：确保每次结转操作都正确设置 source_detail_id
3. **性能优化**：source_detail_id 字段已建立索引，查询性能优于 LIKE 匹配
4. **业务规则**：需要明确是否允许一个明细有多个来源（多次结转）

## 七、实施建议

1. **阶段一**：添加字段和索引，保持现有逻辑不变
2. **阶段二**：修改结转逻辑，新数据使用 source_detail_id
3. **阶段三**：执行数据迁移，补充历史数据的 source_detail_id
4. **阶段四**：修改查询逻辑，完全使用 source_detail_id 判断
5. **阶段五**：清理 memo 中的结转标记（可选）

