# 指标主表简化设计方案分析

## 一、用户提出的简化方案

### 1.1 保留的字段
1. **指标文号** (`quota_doc_no`) - 唯一标识
2. **学年学期ID** (`year_semester_id`) - 关联学年学期
3. **总指标** (`total_quota`) - 总金额（从明细表汇总）
4. **功能分类** (`function_category`) - 小学/初中/高中
5. **经济类型** (`economy_category`) - 助学金/免学杂费/其他
6. **级次** (`budget_level`) - 预算级次
7. **状态** (`status`) - 指标状态
8. **属性** (`quota_source_type`) - 本学期新下达/上学期结转/历史学期结转
9. **备注** (`memo`) - 备注信息
10. **发文时间** (`issue_date`) - 发文日期
11. **创建时间** (`created_at`) - 创建时间

### 1.2 建议移除的字段
- 上级文号 (`superior_doc_no`)
- 指标文标题 (`quota_doc_title`)
- 预算项目编码 (`budget_project_code`)
- 预算项目名称 (`budget_project_name`) ⚠️ **需要评估**
- 指标摘要 (`quota_summary`)
- 预算来源 (`budget_source`)
- 已分配金额 (`allocated_amount`) - 从明细表汇总计算
- 来源指标ID (`source_quota_id`) ⚠️ **需要评估**
- 更新时间 (`updated_at`) - 建议保留

---

## 二、字段使用情况分析

### 2.1 预算项目名称 (`budget_project_name`)

**使用场景**：
1. **预算查询过滤**：学期预算列表可以按预算项目名称过滤
2. **预算项目列表**：提供接口查询所有预算项目名称（去重）
3. **预算显示**：在预算列表中显示预算项目名称

**影响评估**：
- ⚠️ **中等影响**：如果移除，预算查询功能会受影响
- 💡 **解决方案**：
  - 方案A：保留该字段（推荐）
  - 方案B：从明细表关联查询（如果明细表有该字段）
  - 方案C：从预算表反向查询（性能较差）

**建议**：**保留该字段**，因为：
- 预算项目是重要的业务维度
- 用户经常需要按预算项目查询
- 如果放在明细表，一个指标多个明细时会有冗余

---

### 2.2 来源指标ID (`source_quota_id`)

**使用场景**：
1. **结转功能**：记录指标是从哪个历史指标结转而来
2. **结转追溯**：可以查看指标的来源历史
3. **结转金额统计**：可以统计某个指标被结转了多少金额

**影响评估**：
- ⚠️ **高影响**：如果移除，结转功能无法追溯来源
- 💡 **解决方案**：
  - 方案A：保留该字段（推荐）
  - 方案B：使用备注字段记录（不便于查询）
  - 方案C：创建单独的结转关系表（过度设计）

**建议**：**保留该字段**，因为：
- 结转是核心业务功能
- 需要追溯指标来源
- 便于统计和分析

---

### 2.3 其他字段评估

#### 上级文号 (`superior_doc_no`)
- **使用频率**：低
- **影响**：小
- **建议**：可以移除，或放在备注中

#### 指标文标题 (`quota_doc_title`)
- **使用频率**：中
- **影响**：中
- **建议**：可以移除，指标文号已足够标识

#### 预算项目编码 (`budget_project_code`)
- **使用频率**：低
- **影响**：小
- **建议**：可以移除

#### 指标摘要 (`quota_summary`)
- **使用频率**：低
- **影响**：小
- **建议**：可以移除，或放在备注中

#### 预算来源 (`budget_source`)
- **使用频率**：中
- **影响**：中
- **建议**：可以移除，或与"级次"合并考虑

#### 已分配金额 (`allocated_amount`)
- **使用频率**：高
- **影响**：无（从明细表汇总计算）
- **建议**：移除，改为计算字段

#### 更新时间 (`updated_at`)
- **使用频率**：中
- **影响**：中
- **建议**：**保留**，用于审计和追踪

---

## 三、优化后的表结构设计

### 3.1 推荐方案

```sql
CREATE TABLE st_subsidy_quota (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    quota_doc_no VARCHAR(100) NOT NULL COMMENT '指标文号',
    year_semester_id BIGINT NOT NULL COMMENT '学年学期ID',
    total_quota DECIMAL(18,2) DEFAULT 0 COMMENT '总指标金额（从明细表汇总）',
    function_category VARCHAR(20) COMMENT '功能分类（1=小学,2=初中,3=高中）',
    economy_category VARCHAR(20) COMMENT '经济分类（1=助学金,2=免学杂费,3=免学费,4=其他）',
    budget_level VARCHAR(20) COMMENT '预算级次',
    status INT DEFAULT 1 COMMENT '状态（1=启用,2=部分分配,3=已分配,4=锁定）',
    quota_source_type INT DEFAULT 1 COMMENT '指标来源（1=本学期新下达,2=上学期结转,3=历史学期结转）',
    source_quota_id BIGINT COMMENT '来源指标ID（结转时记录）',
    budget_project_name VARCHAR(200) COMMENT '预算项目名称',
    issue_date DATE COMMENT '发文时间',
    memo TEXT COMMENT '备注',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    INDEX idx_quota_doc_no (quota_doc_no),
    INDEX idx_year_semester_id (year_semester_id),
    INDEX idx_economy_category (economy_category),
    INDEX idx_function_category (function_category),
    INDEX idx_source_quota_id (source_quota_id)
) COMMENT='资助指标下达表';
```

### 3.2 字段说明

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `id` | BIGINT | 是 | 主键 |
| `quota_doc_no` | VARCHAR(100) | 是 | 指标文号（唯一标识） |
| `year_semester_id` | BIGINT | 是 | 学年学期ID |
| `total_quota` | DECIMAL(18,2) | 是 | 总指标金额（从明细表汇总） |
| `function_category` | VARCHAR(20) | 否 | 功能分类 |
| `economy_category` | VARCHAR(20) | 否 | 经济分类（主分类，明细表可能有多个） |
| `budget_level` | VARCHAR(20) | 否 | 预算级次 |
| `status` | INT | 是 | 状态 |
| `quota_source_type` | INT | 是 | 指标来源类型 |
| `source_quota_id` | BIGINT | 否 | 来源指标ID（结转时使用） |
| `budget_project_name` | VARCHAR(200) | 否 | 预算项目名称（重要查询维度） |
| `issue_date` | DATE | 否 | 发文时间 |
| `memo` | TEXT | 否 | 备注 |
| `created_at` | DATETIME | 是 | 创建时间 |
| `updated_at` | DATETIME | 是 | 更新时间 |

---

## 四、关键问题分析

### 4.1 主表是否需要经济分类字段？

**问题**：明细表已经有经济分类，主表还需要吗？

**分析**：
- **如果明细表只有一个明细**：主表的经济分类是冗余的
- **如果明细表可能有多个明细**：主表的经济分类可以作为"主分类"或"默认分类"

**建议**：
- **方案A（推荐）**：保留主表的经济分类字段
  - 优点：查询方便，不需要关联明细表
  - 缺点：如果明细表有多个经济分类，主表字段可能不准确
  - 适用场景：一个指标只有一个经济分类明细（符合您的需求）

- **方案B**：移除主表的经济分类字段
  - 优点：数据不冗余
  - 缺点：每次查询都需要关联明细表
  - 适用场景：明细表可能有多个经济分类

**结论**：**保留主表的经济分类字段**，因为：
1. 符合您的需求（一个指标一个经济分类）
2. 查询性能更好
3. 数据一致性更容易保证

---

### 4.2 总指标金额如何计算？

**方案**：从明细表汇总
```sql
-- 查询时计算
SELECT 
    q.*,
    COALESCE(SUM(d.total_amount), 0) as total_quota,
    COALESCE(SUM(d.allocated_amount), 0) as allocated_amount
FROM st_subsidy_quota q
LEFT JOIN st_subsidy_quota_detail d ON q.id = d.quota_id
GROUP BY q.id
```

**或者**：保存时同步更新主表
```java
// 保存明细后，更新主表总金额
private void refreshQuotaTotal(Long quotaId) {
    BigDecimal total = stSubsidyQuotaDetailMapper.sumTotalAmountByQuotaId(quotaId);
    stSubsidyQuotaMapper.updateTotalQuota(quotaId, total);
}
```

**建议**：**保存时同步更新主表**，因为：
- 查询性能更好
- 数据一致性更容易保证
- 便于统计和报表

---

### 4.3 已分配金额如何计算？

**方案**：从预算表汇总
```sql
-- 查询时计算
SELECT 
    q.*,
    COALESCE(SUM(b.budget_amount), 0) as allocated_amount
FROM st_subsidy_quota q
LEFT JOIN st_semester_budget b ON q.id = b.quota_id
GROUP BY q.id
```

**或者**：保存时同步更新主表
```java
// 分配预算后，更新主表已分配金额
private void refreshQuotaAllocated(Long quotaId) {
    BigDecimal allocated = stSemesterBudgetMapper.sumBudgetAmountByQuotaId(quotaId);
    stSubsidyQuotaMapper.updateAllocatedAmount(quotaId, allocated);
}
```

**建议**：**保存时同步更新主表**，因为：
- 查询性能更好
- 便于状态计算（已分配/部分分配/未分配）

---

## 五、最终推荐方案

### 5.1 表结构

```sql
CREATE TABLE st_subsidy_quota (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    quota_doc_no VARCHAR(100) NOT NULL COMMENT '指标文号',
    year_semester_id BIGINT NOT NULL COMMENT '学年学期ID',
    total_quota DECIMAL(18,2) DEFAULT 0 COMMENT '总指标金额（从明细表汇总）',
    allocated_amount DECIMAL(18,2) DEFAULT 0 COMMENT '已分配金额（从预算表汇总）',
    function_category VARCHAR(20) COMMENT '功能分类',
    economy_category VARCHAR(20) COMMENT '经济分类（主分类）',
    budget_level VARCHAR(20) COMMENT '预算级次',
    status INT DEFAULT 1 COMMENT '状态',
    quota_source_type INT DEFAULT 1 COMMENT '指标来源（1=本学期,2=上学期结转,3=历史结转）',
    source_quota_id BIGINT COMMENT '来源指标ID',
    budget_project_name VARCHAR(200) COMMENT '预算项目名称',
    issue_date DATE COMMENT '发文时间',
    memo TEXT COMMENT '备注',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_quota_doc_no (quota_doc_no),
    INDEX idx_year_semester_id (year_semester_id),
    INDEX idx_economy_category (economy_category),
    INDEX idx_function_category (function_category),
    INDEX idx_source_quota_id (source_quota_id)
) COMMENT='资助指标下达表';
```

### 5.2 字段说明

**核心字段（必填）**：
- `quota_doc_no` - 指标文号
- `year_semester_id` - 学年学期ID
- `total_quota` - 总指标金额
- `allocated_amount` - 已分配金额
- `status` - 状态
- `quota_source_type` - 指标来源类型

**分类字段**：
- `function_category` - 功能分类
- `economy_category` - 经济分类
- `budget_level` - 预算级次

**业务字段**：
- `source_quota_id` - 来源指标ID（结转用）
- `budget_project_name` - 预算项目名称
- `issue_date` - 发文时间
- `memo` - 备注

**时间字段**：
- `created_at` - 创建时间
- `updated_at` - 更新时间

---

## 六、实施建议

### 6.1 数据迁移

1. **备份现有数据**
2. **创建新表结构**
3. **迁移数据**：
   - 保留核心字段
   - 从明细表汇总 `total_quota`
   - 从预算表汇总 `allocated_amount`
   - 从明细表取第一个经济分类作为主表 `economy_category`
4. **验证数据一致性**

### 6.2 代码改造

1. **实体类**：移除不需要的字段
2. **Mapper XML**：更新查询SQL
3. **Service层**：更新汇总逻辑
4. **Controller层**：更新接口
5. **前端**：更新表单和列表

### 6.3 注意事项

1. **数据一致性**：确保 `total_quota` 和明细表汇总一致
2. **性能优化**：`total_quota` 和 `allocated_amount` 保存时同步更新
3. **查询兼容**：保留预算项目名称查询功能
4. **结转功能**：保留 `source_quota_id` 字段

---

## 七、总结

### 7.1 合理性评估

✅ **合理的设计**：
- 字段精简，符合业务需求
- 保留核心业务字段
- 明细表保留，支持扩展

⚠️ **需要注意**：
- 建议保留 `budget_project_name`（预算查询需要）
- 建议保留 `source_quota_id`（结转功能需要）
- 建议保留 `updated_at`（审计需要）
- `total_quota` 和 `allocated_amount` 需要同步更新

### 7.2 最终建议

**保留字段**（15个）：
1. `id` - 主键
2. `quota_doc_no` - 指标文号
3. `year_semester_id` - 学年学期ID
4. `total_quota` - 总指标金额
5. `allocated_amount` - 已分配金额
6. `function_category` - 功能分类
7. `economy_category` - 经济分类
8. `budget_level` - 预算级次
9. `status` - 状态
10. `quota_source_type` - 指标来源类型
11. `source_quota_id` - 来源指标ID ⭐
12. `budget_project_name` - 预算项目名称 ⭐
13. `issue_date` - 发文时间
14. `memo` - 备注
15. `created_at` - 创建时间
16. `updated_at` - 更新时间 ⭐

**移除字段**：
- `superior_doc_no` - 上级文号
- `quota_doc_title` - 指标文标题
- `budget_project_code` - 预算项目编码
- `quota_summary` - 指标摘要
- `budget_source` - 预算来源

⭐ 标记的字段是建议额外保留的字段





