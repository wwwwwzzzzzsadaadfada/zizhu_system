# 指标表结构更新 - 后续步骤清单

## ✅ 已完成
- [x] 数据库表结构更新（删除5个字段）
- [x] 后端代码修改（实体类、Mapper、Service）
- [x] 前端代码修改（页面、表单、列表）

---

## 📋 后续步骤清单

### 一、数据库验证（必须）

#### 1.1 验证字段已删除
```sql
-- 执行此SQL，应该返回0行（表示字段已成功删除）
SELECT COLUMN_NAME 
FROM information_schema.COLUMNS 
WHERE TABLE_SCHEMA = DATABASE() 
  AND TABLE_NAME = 'st_subsidy_quota' 
  AND COLUMN_NAME IN (
    'superior_doc_no',
    'quota_doc_title', 
    'budget_project_code',
    'quota_summary',
    'budget_source'
  );
```

#### 1.2 查看当前表结构
```sql
-- 查看表结构，确认字段正确
DESC st_subsidy_quota;

-- 或者查看建表语句
SHOW CREATE TABLE st_subsidy_quota;
```

#### 1.3 验证数据完整性
```sql
-- 检查是否有数据丢失
SELECT COUNT(*) as total_count FROM st_subsidy_quota;

-- 检查关键字段是否有数据
SELECT 
    COUNT(*) as total,
    COUNT(quota_doc_no) as has_quota_doc_no,
    COUNT(budget_project_name) as has_budget_project_name,
    COUNT(total_quota) as has_total_quota
FROM st_subsidy_quota;
```

---

### 二、应用服务重启（必须）

#### 2.1 停止应用服务
```bash
# 根据您的部署方式选择
# 方式1：如果使用systemd
sudo systemctl stop your-app-service

# 方式2：如果使用Tomcat
sudo systemctl stop tomcat

# 方式3：如果使用Spring Boot jar
# 找到进程并kill
ps aux | grep java
kill -9 <PID>
```

#### 2.2 清理缓存（可选但推荐）
```bash
# 清理编译缓存
cd /path/to/your/project
mvn clean  # Maven项目
# 或
./gradlew clean  # Gradle项目
```

#### 2.3 重新编译（如果需要）
```bash
# Maven项目
mvn clean package -DskipTests

# Gradle项目
./gradlew clean build -x test
```

#### 2.4 启动应用服务
```bash
# 方式1：systemd
sudo systemctl start your-app-service
sudo systemctl status your-app-service

# 方式2：Tomcat
sudo systemctl start tomcat

# 方式3：Spring Boot jar
java -jar your-app.jar
```

---

### 三、功能测试（必须）

#### 3.1 指标管理功能测试

**测试点1：指标列表查询**
- [ ] 打开指标管理页面
- [ ] 验证列表能正常加载
- [ ] 验证不再显示"指标标题"和"预算来源"列
- [ ] 验证筛选功能正常（功能分类、经济分类等）

**测试点2：新增指标**
- [ ] 点击"新增"按钮
- [ ] 验证表单不再包含以下字段：
  - [ ] 指标标题
  - [ ] 上级文号
  - [ ] 预算项目编码
  - [ ] 指标摘要
  - [ ] 预算来源
- [ ] 填写必填字段并保存
- [ ] 验证保存成功

**测试点3：编辑指标**
- [ ] 选择一条记录点击"编辑"
- [ ] 验证表单字段正确
- [ ] 修改数据并保存
- [ ] 验证更新成功

**测试点4：指标详情查看**
- [ ] 点击查看详情
- [ ] 验证详情页面不再显示已删除的字段
- [ ] 验证数据展示正确

**测试点5：指标结转**
- [ ] 测试指标结转功能
- [ ] 验证结转时不再使用已删除的字段
- [ ] 验证结转成功

#### 3.2 学期预算功能测试

**测试点1：预算列表**
- [ ] 打开学期预算页面
- [ ] 验证列表能正常加载
- [ ] 验证"关联指标"列显示指标文号（不再是标题）
- [ ] 验证详情页面不再显示"指标标题"和"预算来源"

**测试点2：预算分配**
- [ ] 测试预算分配功能
- [ ] 验证能正常选择指标
- [ ] 验证分配成功

#### 3.3 学生补助功能测试

**测试点1：补助记录查询**
- [ ] 打开学生补助记录页面
- [ ] 验证列表能正常加载
- [ ] 验证关联的指标信息显示正确

**测试点2：新增补助**
- [ ] 测试新增补助功能
- [ ] 验证能正常选择预算
- [ ] 验证保存成功

---

### 四、数据验证（重要）

#### 4.1 验证现有数据
```sql
-- 检查指标数据是否完整
SELECT 
    id,
    quota_doc_no,
    budget_project_name,
    total_quota,
    function_category,
    economy_category,
    status
FROM st_subsidy_quota
LIMIT 10;

-- 检查明细表数据
SELECT 
    d.id,
    d.quota_id,
    d.economy_category,
    d.total_amount,
    q.quota_doc_no
FROM st_subsidy_quota_detail d
LEFT JOIN st_subsidy_quota q ON d.quota_id = q.id
LIMIT 10;

-- 检查预算表数据
SELECT 
    b.id,
    b.quota_id,
    b.quota_detail_id,
    q.quota_doc_no,
    b.budget_amount
FROM st_semester_budget b
LEFT JOIN st_subsidy_quota q ON b.quota_id = q.id
LIMIT 10;
```

#### 4.2 验证关联查询
```sql
-- 验证指标与明细的关联
SELECT 
    q.id,
    q.quota_doc_no,
    COUNT(d.id) as detail_count,
    SUM(d.total_amount) as total_detail_amount,
    q.total_quota
FROM st_subsidy_quota q
LEFT JOIN st_subsidy_quota_detail d ON q.id = d.quota_id
GROUP BY q.id, q.quota_doc_no, q.total_quota
LIMIT 10;

-- 验证指标与预算的关联
SELECT 
    q.id,
    q.quota_doc_no,
    COUNT(b.id) as budget_count,
    SUM(b.budget_amount) as total_budget_amount
FROM st_subsidy_quota q
LEFT JOIN st_semester_budget b ON q.id = b.quota_id
GROUP BY q.id, q.quota_doc_no
LIMIT 10;
```

---

### 五、错误排查（如遇问题）

#### 5.1 常见问题

**问题1：应用启动失败**
- 检查日志文件，查看具体错误信息
- 确认数据库连接正常
- 确认所有依赖已正确加载

**问题2：页面显示错误**
- 清除浏览器缓存
- 检查前端控制台错误信息
- 确认前端代码已正确部署

**问题3：数据查询异常**
- 检查SQL日志，确认查询语句正确
- 验证数据库表结构是否正确
- 检查Mapper XML文件是否正确

**问题4：字段不存在错误**
- 确认数据库字段已删除
- 检查后端代码是否还有引用已删除字段的地方
- 检查前端代码是否还有引用已删除字段的地方

#### 5.2 日志检查
```bash
# 查看应用日志
tail -f /path/to/your/app/logs/application.log

# 查看错误日志
grep -i error /path/to/your/app/logs/application.log

# 查看数据库相关错误
grep -i "sql\|database\|mysql" /path/to/your/app/logs/application.log
```

---

### 六、性能检查（可选）

#### 6.1 查询性能
```sql
-- 检查索引是否生效
EXPLAIN SELECT * FROM st_subsidy_quota WHERE quota_doc_no = 'test';

-- 检查慢查询
SHOW VARIABLES LIKE 'slow_query_log';
SHOW VARIABLES LIKE 'long_query_time';
```

#### 6.2 应用性能
- 监控应用响应时间
- 检查内存使用情况
- 检查数据库连接池状态

---

### 七、文档更新（建议）

- [ ] 更新API文档（如果有）
- [ ] 更新用户手册（如果有）
- [ ] 更新开发文档（如果有）
- [ ] 记录本次修改内容到变更日志

---

### 八、回滚准备（应急预案）

如果出现问题需要回滚，执行以下SQL：

```sql
-- 重新添加已删除的字段（回滚）
ALTER TABLE st_subsidy_quota 
    ADD COLUMN superior_doc_no VARCHAR(100) COMMENT '上级文号' AFTER issue_date;

ALTER TABLE st_subsidy_quota 
    ADD COLUMN quota_doc_title VARCHAR(200) COMMENT '指标文标题' AFTER superior_doc_no;

ALTER TABLE st_subsidy_quota 
    ADD COLUMN budget_project_code VARCHAR(50) COMMENT '预算项目编码' AFTER quota_doc_no;

ALTER TABLE st_subsidy_quota 
    ADD COLUMN quota_summary TEXT COMMENT '指标摘要' AFTER budget_project_name;

ALTER TABLE st_subsidy_quota 
    ADD COLUMN budget_source VARCHAR(20) COMMENT '预算来源' AFTER economy_category;
```

**注意**：回滚后需要：
1. 恢复代码到修改前的版本
2. 如果有数据备份，恢复已删除字段的数据
3. 重启应用服务

---

## 📝 检查清单总结

### 必须完成
- [ ] 数据库验证（字段已删除）
- [ ] 应用服务重启
- [ ] 指标管理功能测试
- [ ] 学期预算功能测试
- [ ] 数据完整性验证

### 建议完成
- [ ] 学生补助功能测试
- [ ] 性能检查
- [ ] 文档更新
- [ ] 日志检查

### 应急预案
- [ ] 准备回滚脚本
- [ ] 准备数据备份

---

## 🎯 完成标准

所有功能测试通过，且满足以下条件：
1. ✅ 数据库表结构正确
2. ✅ 应用服务正常运行
3. ✅ 所有页面正常显示
4. ✅ 新增/编辑功能正常
5. ✅ 数据查询正常
6. ✅ 无错误日志

---

**完成时间记录**：________________

**测试人员**：________________

**备注**：________________




